<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JW Quiz</title>

  <style>
    :root{
      --sky1:#4cc3ff;
      --sky2:#2a8dff;
      --bg:#eaf6ff;
      --panel:#ffffff;
      --panel2:#f5fbff;
      --line:#bfe6ff;
      --ink:#12304a;
      --muted:#4f6b86;
      --shadow: 0 14px 30px rgba(0,0,0,.14);
      --shadowSoft: 0 10px 18px rgba(0,0,0,.10);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 650px at 20% 0%, rgba(255,255,255,.65), transparent 55%),
        radial-gradient(900px 650px at 90% 10%, rgba(255,255,255,.45), transparent 55%),
        linear-gradient(180deg, var(--sky1), var(--sky2) 35%, var(--bg) 35%, var(--bg));
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:14px;
      color:var(--ink);
    }
    .wrap{width:min(460px, 100%);}

    .hud{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.22);
      border:1px solid rgba(255,255,255,.40);
      box-shadow: var(--shadow);
      color:#fff;
      backdrop-filter: blur(8px);
    }
    .hud-center{
      font-weight:950;
      letter-spacing:.2px;
      text-shadow: 0 2px 10px rgba(0,0,0,.15);
      user-select:none;
      cursor:pointer;
    }
    .hud-right{display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap}
    .hud-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.35);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      user-select:none;
    }
    .hud-pill strong{ font-variant-numeric: tabular-nums; }

    .track{ position:relative; margin:12px 0 14px; height:48px; }
    .track-line{
      position:absolute; left:18px; right:18px; top:50%;
      height:10px; transform:translateY(-50%);
      background: rgba(255,255,255,.65);
      border:1px solid rgba(255,255,255,.95);
      border-radius:999px;
      box-shadow: inset 0 2px 6px rgba(0,0,0,.10);
    }
    .track-dot{
      position:absolute; top:50%;
      width:18px;height:18px; transform:translate(-50%,-50%);
      border-radius:999px;
      background:#ffe27a;
      border:2px solid rgba(255,255,255,.98);
      box-shadow: 0 6px 14px rgba(0,0,0,.16);
      transition:left .2s ease;
    }
    .avatar{
      position:absolute; top:50%;
      width:36px; height:36px; transform:translateY(-50%);
      border-radius:999px;
      background: rgba(255,255,255,.96);
      border:1px solid rgba(0,0,0,.08);
      display:grid; place-items:center;
      box-shadow: 0 10px 18px rgba(0,0,0,.14);
      font-size:18px; user-select:none;
    }
    .avatar.left{left:0}
    .avatar.right{right:0}

    .card{
      position:relative;
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateZ(0);
    }
    .card-top{
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(58,166,255,.14), rgba(58,166,255,.04));
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(58,166,255,.08);
      color: var(--muted);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .tag strong{color:var(--ink)}
    .counter{ font-size:12px; color:var(--muted); font-weight:900; white-space:nowrap; }

    .qarea{
      padding:14px;
      display:grid;
      grid-template-columns: 82px 1fr;
      gap:12px;
      align-items:center;
      background: linear-gradient(180deg, #ffffff, var(--panel2));
    }
    .qmedia{
      width:82px; height:82px;
      border-radius: 14px;
      background: #f2fbff;
      border: 1px dashed #a9dcff;
      display:grid;
      place-items:center;
      font-size:32px;
      user-select:none;
    }
    .qtext{ font-size:16px; font-weight:950; line-height:1.2; }

    .ref{
      padding:0 14px 12px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      display:none;
    }

    .btn{
      width:100%;
      margin-top:12px;
      padding:14px 12px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.10);
      background: linear-gradient(180deg, #ffffff, #eaf7ff);
      font-size:16px;
      font-weight:950;
      color:var(--ink);
      box-shadow: var(--shadowSoft);
      cursor:pointer;
      user-select:none;
      text-align:center;
      transition: transform .06s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .btn:hover{ box-shadow: 0 14px 26px rgba(0,0,0,.12); border-color: rgba(58,166,255,.35); }
    .btn:active{ transform: scale(.99); }
    .btn[disabled]{opacity:.55; cursor:not-allowed;}
    .btn.secondary{ background: linear-gradient(180deg, #ffffff, #f3fbff); }
    .btn.gold{ background: linear-gradient(180deg, #fff8d9, #ffeaa9); }

    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .row .btn{flex:1; min-width:140px; margin-top:0;}

    .answers{margin-top:12px; display:grid; gap:10px;}
    .ansbtn{
      width:100%;
      text-align:center;
      padding:14px 12px;
      font-size:16px;
      font-weight:950;
      color:var(--ink);
      border-radius: 14px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff, #eaf7ff);
      box-shadow: var(--shadowSoft);
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .ansbtn:hover{border-color: rgba(58,166,255,.35); box-shadow: 0 14px 26px rgba(0,0,0,.12);}
    .ansbtn:active{transform: scale(.99)}
    .ansbtn[disabled]{opacity:.55; cursor:not-allowed}
    .ansbtn.correct{border-color: rgba(26,165,106,.45); background: rgba(26,165,106,.08);}
    .ansbtn.wrong{border-color: rgba(229,72,93,.45); background: rgba(229,72,93,.07);}

    .order-wrap{margin-top:12px; display:grid; gap:10px;}
    .order-zone{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:10px;
      box-shadow: var(--shadowSoft);
    }
    .order-title{
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      margin:0 0 8px 0;
    }
    .chips{display:flex; flex-wrap:wrap; gap:8px;}
    .chipbtn{
      border:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff, #f2fbff);
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      color:var(--ink);
      cursor:pointer;
      box-shadow: 0 10px 16px rgba(0,0,0,.08);
      user-select:none;
    }
    .chipbtn[disabled]{opacity:.45; cursor:not-allowed}

    .result{
      margin-top:12px;
      padding:12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
    }
    .result.good{border-color: rgba(26,165,106,.35); background: rgba(26,165,106,.06)}
    .result.bad{border-color: rgba(229,72,93,.35); background: rgba(229,72,93,.05)}
    .result .title{font-weight:950}
    .result .small{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35}

    .controls{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;}
    .ctrl{
      flex:1; min-width:140px;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:950;
      color:var(--ink);
      box-shadow: var(--shadowSoft);
      cursor:pointer;
      user-select:none;
      text-align:center;
    }
    .ctrl.danger{
      border-color: rgba(229,72,93,.25);
      background: rgba(229,72,93,.06);
    }
    .ctrl.gold{
      border-color: rgba(255,206,92,.55);
      background: rgba(255,206,92,.18);
    }

    .form{ display:grid; gap:10px; margin-top:12px; }
    .field{ display:grid; gap:6px; }
    .label{ font-size:12px; font-weight:900; color:var(--muted); }
    .input{
      width:100%;
      padding:14px 12px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.10);
      background: linear-gradient(180deg, #ffffff, #f3fbff);
      font-weight:950;
      color:var(--ink);
      outline:none;
      box-shadow: var(--shadowSoft);
      transition: box-shadow .18s ease, border-color .18s ease;
    }
    .input:focus{
      border-color: rgba(58,166,255,.45);
      box-shadow: 0 14px 26px rgba(0,0,0,.12);
    }
    .hint{ font-size:12px; color:var(--muted); line-height:1.35; }

    .themes{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .theme-card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff, #f3fbff);
      border-radius: 16px;
      padding:12px;
      box-shadow: var(--shadowSoft);
      cursor:pointer;
      user-select:none;
      text-align:left;
      transition: transform .06s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .theme-card:hover{
      border-color: rgba(58,166,255,.35);
      box-shadow: 0 14px 26px rgba(0,0,0,.12);
    }
    .theme-card:active{ transform: scale(.99); }
    .theme-card.selected{
      border-color: rgba(26,165,106,.35);
      background: linear-gradient(180deg, rgba(26,165,106,.08), #ffffff);
    }
    .theme-card .t-top{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .theme-card .t-ico{ font-size:18px; }
    .theme-card .t-name{ font-weight:950; }
    .theme-card .t-sub{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.25; }

    /* Aventure */
    .adv-banner{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,204,77,.20), rgba(255,204,77,.06));
      box-shadow: var(--shadowSoft);
    }
    .adv-banner .big{font-weight:950}
    .adv-banner .small{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35}

    .map{ margin-top:12px; display:grid; gap:10px; }
    .lvl{
      border:1px solid var(--line);
      border-radius: 16px;
      background: #fff;
      box-shadow: var(--shadowSoft);
      overflow:hidden;
    }
    .lvl-head{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(58,166,255,.10), rgba(58,166,255,.03));
      cursor:pointer;
      user-select:none;
    }
    .lvl-left{display:flex; align-items:center; gap:10px; min-width:0;}
    .badge{
      width:34px;height:34px;
      border-radius:12px;
      display:grid; place-items:center;
      border:1px solid rgba(0,0,0,.08);
      background: linear-gradient(180deg,#fff,#f2fbff);
      box-shadow: 0 10px 16px rgba(0,0,0,.08);
      font-weight:950;
    }
    .lvl-title{
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .lvl-right{display:flex; align-items:center; gap:10px; flex:0 0 auto;}
    .stars{font-weight:950; color:#946200; white-space:nowrap;}
    .lock{font-weight:950; color:var(--muted)}
    .lvl-body{
      padding:10px 12px 12px;
      display:grid;
      gap:8px;
      background: linear-gradient(180deg, #fff, #f7fcff);
    }
    .lvl-body[hidden]{display:none}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(191,230,255,.95);
      background: rgba(58,166,255,.06);
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      width:max-content;
    }
    .pill strong{color:var(--ink)}

    /* Menu Modes */
    .mode-grid{ margin-top:12px; display:grid; gap:10px; }
    .mode-card{
      border:1px solid var(--line);
      border-radius: 18px;
      background: #fff;
      box-shadow: var(--shadowSoft);
      padding:12px;
      display:grid;
      gap:10px;
    }
    .mode-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .mode-title{
      font-weight:950;
      display:flex;
      align-items:center;
      gap:10px;
      font-size:16px;
    }
    .mode-desc{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    /* ===== Mots crois√©s ===== */
    .xw-wrap{ margin-top:12px; display:grid; gap:12px; }
    .xw-toprow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .xw-stats{ display:flex; gap:8px; flex-wrap:wrap; }

    .xw-grid{
      border:1px solid var(--line);
      border-radius: 16px;
      overflow:hidden;
      box-shadow: var(--shadowSoft);
      background:#fff;
      display:grid;
      gap:1px;
      padding:1px;
    }
    .xw-cell{
      position:relative;
      background:#f6fbff;
      border:1px solid rgba(191,230,255,.65);
      aspect-ratio: 1 / 1;
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .xw-cell.block{ background: #1b3d5a; border-color: rgba(0,0,0,.10); }
    .xw-cell input{
      width:100%;
      height:100%;
      border:0;
      outline:none;
      background:transparent;
      text-align:center;
      font-weight:950;
      font-size:16px;
      color:var(--ink);
      text-transform: uppercase;
      caret-color: transparent;
    }
    .xw-cell .num{
      position:absolute;
      top:2px; left:3px;
      font-size:10px;
      font-weight:950;
      color: rgba(18,48,74,.72);
      user-select:none;
      pointer-events:none;
    }
    .xw-cell.selected{ box-shadow: inset 0 0 0 2px rgba(58,166,255,.80); background: rgba(58,166,255,.08); }
    .xw-cell.bad{ background: rgba(229,72,93,.12); box-shadow: inset 0 0 0 2px rgba(229,72,93,.35); }
    .xw-cell.good{ background: rgba(26,165,106,.10); }

    .xw-cell.hint{
      box-shadow: inset 0 0 0 3px rgba(255,206,92,.95);
      background: rgba(255,206,92,.22) !important;
    }

    .xw-clues{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .xw-panel{
      border:1px solid var(--line);
      border-radius: 16px;
      background:#fff;
      box-shadow: var(--shadowSoft);
      padding:10px;
      overflow:hidden;
    }
    .xw-panel h3{
      margin:0 0 8px 0;
      font-size:12px;
      color:var(--muted);
      font-weight:950;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .xw-cluelist{
      display:grid;
      gap:8px;
      font-size:12px;
      color:var(--ink);
      line-height:1.3;
      max-height: 240px;
      overflow:auto;
      padding-right:4px;
    }
    .xw-clue{
      padding:8px;
      border:1px solid rgba(191,230,255,.75);
      border-radius:12px;
      background: rgba(58,166,255,.05);
    }
    .xw-clue .n{ font-weight:950; color:var(--ink); }
    .xw-footnote{ font-size:12px; color:var(--muted); line-height:1.35; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hud">
      <div class="hud-center" id="hudTitle">JW Quiz</div>
      <div class="hud-right">
        <span class="hud-pill" title="Profil">üë§ <strong id="profileName">‚Äî</strong></span>
        <span class="hud-pill">ü™ô <strong id="coins">0</strong></span>
        <span class="hud-pill" id="heartsPill" style="display:none;">‚ù§Ô∏è <strong id="hearts">0</strong></span>
      </div>
    </div>

    <div class="track">
      <div class="track-line"></div>
      <div class="track-dot" id="trackDot" style="left:50%"></div>
      <div class="avatar left" title="Joueur">üôÇ</div>
      <div class="avatar right" title="Adversaire">üòÑ</div>
    </div>

    <div class="card">
      <div class="card-top">
        <div class="tag">
          <span id="qType">MENU</span>
          ‚Ä¢ Th√®me : <strong id="themeLabel">Mixte</strong>
          ‚Ä¢ Difficult√© : <strong id="diffStars">‚Äî</strong>
        </div>
        <div class="counter" id="counter">‚Äî</div>
      </div>

      <div class="qarea">
        <div class="qmedia" id="qmedia">üìò</div>
        <div class="qtext" id="qtext">Bienvenue</div>
      </div>

      <div class="ref" id="ref"></div>

      <div style="padding: 0 14px 14px;">
        <div id="gameArea"></div>
        <div class="result" id="resultBox" style="display:none;"></div>

        <div class="controls" id="controls" style="display:none;">
          <button class="ctrl gold" id="btnJoker">üÉè Joker (2 ü™ô)</button>
          <button class="ctrl" id="btnSkip">‚è≠Ô∏è Passer</button>
          <button class="ctrl danger" id="btnEnd">‚õî Finir</button>
        </div>

        <div class="footer" id="footer"></div>
      </div>
    </div>
  </div>

  <!-- Donn√©es -->
  <script src="questions.js"></script>
  <script src="crosswords.js"></script>

  <script>
  /* ========= Donn√©es externes ========= */
  const THEMES = window.THEMES || [];
  const QUESTIONS = window.QUESTIONS || [];
  const CROSSWORD_BANKS = window.CROSSWORD_BANKS || [];

  /* ========= R√®gles ========= */
  const COINS_START = 0;
  const COINS_PER_GOOD = 2;
  const JOKER_COST = 2;
  const ADVENTURE_HEARTS_START = 3;

  const ADVENTURE_LEVELS = [
    { n:1,  name:"Tutoriel",   qCount:5,  minD:1, maxD:1, minTypes:["QCM","VF"], boss:false },
    { n:2,  name:"D√©part",     qCount:7,  minD:1, maxD:2, minTypes:["QCM","VF"], boss:false },
    { n:3,  name:"Chemin",     qCount:8,  minD:2, maxD:3, minTypes:["QCM","VF","TROU"], boss:false },
    { n:4,  name:"For√™t",      qCount:9,  minD:2, maxD:3, minTypes:["QCM","TROU"], boss:false },
    { n:5,  name:"Mini Boss",  qCount:10, minD:3, maxD:4, minTypes:["QCM","ORDRE"], boss:true },
    { n:6,  name:"Mont√©e",     qCount:10, minD:3, maxD:4, minTypes:["QCM","VF","TROU"], boss:false },
    { n:7,  name:"Plateau",    qCount:10, minD:3, maxD:4, minTypes:["QCM","ORDRE"], boss:false },
    { n:8,  name:"√âpreuve",    qCount:10, minD:4, maxD:4, minTypes:["QCM","TROU"], boss:false },
    { n:9,  name:"Avant-boss", qCount:10, minD:4, maxD:5, minTypes:["QCM","VF","ORDRE"], boss:false },
    { n:10, name:"Boss",       qCount:10, minD:4, maxD:5, minTypes:["QCM","VF","TROU","ORDRE"], boss:true },
  ];

  const STORAGE_KEY = "jwquiz_pack_v2025_12_19";

  /* ========= Helpers ========= */
  const $ = (s)=>document.querySelector(s);
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function normalize(s){
    return String(s ?? "").trim().toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/\s+/g," ");
  }
  function normalizeLettersOnly(s){
    return String(s ?? "")
      .toUpperCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^A-Z]/g,"");
  }
  function shuffle(a){
    a = a.slice();
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }
  function stars(n){
    n=Math.max(1,Math.min(5,Number(n)||1));
    return "‚≠ê".repeat(n);
  }
  function pickMedia(q){
    const t=(q.type||"QCM").toUpperCase();
    if(t==="ORDRE") return "üß©";
    if(t==="TROU") return "üï≥Ô∏è";
    if(t==="VF") return "‚úÖ";
    const d=Number(q.difficulty)||1;
    return d<=1?"üìò":d===2?"üìó":d===3?"üìô":d===4?"üìï":"üëë";
  }
  function splitOrderAnswer(ans){
    const raw=String(ans??"").trim();
    if(!raw) return [];
    if(raw.includes("|")) return raw.split("|").map(x=>x.trim()).filter(Boolean);
    if(raw.includes(",")) return raw.split(",").map(x=>x.trim()).filter(Boolean);
    return raw.split(/\s+/).map(x=>x.trim()).filter(Boolean);
  }

  /* ========= UI ========= */
  const ui = {
    coins: $("#coins"),
    profileName: $("#profileName"),
    hudTitle: $("#hudTitle"),
    trackDot: $("#trackDot"),
    qType: $("#qType"),
    themeLabel: $("#themeLabel"),
    diffStars: $("#diffStars"),
    counter: $("#counter"),
    qmedia: $("#qmedia"),
    qtext: $("#qtext"),
    ref: $("#ref"),
    gameArea: $("#gameArea"),
    resultBox: $("#resultBox"),
    controls: $("#controls"),
    btnJoker: $("#btnJoker"),
    btnSkip: $("#btnSkip"),
    btnEnd: $("#btnEnd"),
    footer: $("#footer"),
    heartsPill: $("#heartsPill"),
    hearts: $("#hearts"),
  };

  /* ========= State ========= */
  const defaultState = () => ({
    profile: null,
    coins: COINS_START,
    selectedTheme: "Mixte",
    correctIds: {},
    session: null, // {mode:'classic'|'adventure'|'crossword', ...}
    adventure: { currentLevel: 1, hearts: ADVENTURE_HEARTS_START, levelStars:{} },
    crossword: { wins: 0, selectedBank: (CROSSWORD_BANKS[0]?.key || "grille1") }
  });

  let state = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const st = raw ? Object.assign(defaultState(), JSON.parse(raw)) : defaultState();
      if(!st.adventure) st.adventure = defaultState().adventure;
      if(!st.crossword) st.crossword = defaultState().crossword;
      if(!st.correctIds) st.correctIds = {};
      if(typeof st.coins !== "number") st.coins = COINS_START;
      if(!st.selectedTheme) st.selectedTheme = "Mixte";
      if(typeof st.adventure.hearts !== "number") st.adventure.hearts = ADVENTURE_HEARTS_START;
      if(!st.adventure.currentLevel) st.adventure.currentLevel = 1;
      if(!st.adventure.levelStars) st.adventure.levelStars = {};
      if(!st.crossword.selectedBank) st.crossword.selectedBank = (CROSSWORD_BANKS[0]?.key || "grille1");
      if(typeof st.crossword.wins !== "number") st.crossword.wins = 0;
      return st;
    }catch(e){
      return defaultState();
    }
  }
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  function setHeartsVisible(show){
    ui.heartsPill.style.display = show ? "inline-flex" : "none";
  }
  function updateTopBar(){
    ui.coins.textContent = String(state.coins);
    ui.profileName.textContent = state.profile?.name ? state.profile.name : "‚Äî";
    ui.themeLabel.textContent = state.selectedTheme || "Mixte";
    ui.hearts.textContent = String(state.adventure?.hearts ?? 0);
    setHeartsVisible(state.session?.mode === "adventure");
  }
  ui.hudTitle.onclick = ()=> renderModeMenu();

  function setHeader({type="MENU", theme=state.selectedTheme, diff="‚Äî", counter="‚Äî", media="üìò", title=""}){
    ui.qType.textContent = type;
    ui.themeLabel.textContent = theme || "Mixte";
    ui.diffStars.textContent = diff;
    ui.counter.textContent = counter;
    ui.qmedia.textContent = media;
    ui.qtext.textContent = title;
  }
  function clearFooter(){
    ui.footer.innerHTML = "";
    ui.resultBox.style.display = "none";
    ui.controls.style.display = "none";
    ui.ref.style.display = "none";
  }

  /* ========= Profile ========= */
  function renderProfileGate(){
    state.session = null;
    saveState();
    updateTopBar();
    clearFooter();
    setHeartsVisible(false);

    setHeader({type:"COMPTE", theme:"‚Äî", diff:"‚Äî", counter:"‚Äî", media:"üë§", title:"Cr√©er ton compte"});
    ui.trackDot.style.left = "50%";

    ui.gameArea.innerHTML = `
      <div class="hint">Ton compte reste enregistr√© sur cet appareil.</div>
      <div class="form">
        <div class="field">
          <div class="label">Pseudo *</div>
          <input class="input" id="inpName" maxlength="18" placeholder="Ex: Vincenzo" />
        </div>
        <button class="btn" id="btnCreate">‚úÖ Cr√©er mon compte</button>
      </div>
    `;
    $("#btnCreate").onclick = ()=>{
      const name = ($("#inpName").value || "").trim();
      if(!name){ ui.footer.innerHTML = "‚ö†Ô∏è Mets un pseudo."; return; }
      state.profile = { id: "id_"+Date.now(), name };
      saveState();
      renderModeMenu();
    };
  }

  /* ========= Counts / stats ========= */
  function computeCounts(){
    const correct = state.correctIds || {};
    const totalAll = QUESTIONS.length;
    const doneAll = Object.keys(correct).filter(id => QUESTIONS.some(q=>q.id===id)).length;

    const byTheme = {};
    THEMES.forEach(t=>{
      if(t.key === "Mixte") return;
      const list = QUESTIONS.filter(q => (q.theme||"Bible") === t.key);
      const done = list.filter(q => !!correct[q.id]).length;
      byTheme[t.key] = { total: list.length, remaining: Math.max(0, list.length - done), done };
    });

    return { totalAll, doneAll, remainingAll: Math.max(0, totalAll - doneAll), byTheme };
  }

  /* ========= Mode menu ========= */
  function renderModeMenu(){
    updateTopBar();
    clearFooter();
    setHeartsVisible(false);

    if(!state.profile){ renderProfileGate(); return; }

    const counts = computeCounts();
    const lvl = Math.max(1, Math.min(ADVENTURE_LEVELS.length, Number(state.adventure.currentLevel)||1));

    setHeader({
      type:"ACCUEIL",
      theme: state.selectedTheme,
      diff:"‚Äî",
      counter:"‚Äî",
      media:"üéÆ",
      title:"Choisis ton mode"
    });
    ui.trackDot.style.left = "50%";

    ui.gameArea.innerHTML = `
      <div class="hint">
        üëã ${esc(state.profile.name)}
        ‚Ä¢ Pi√®ces : <strong>${state.coins}</strong>
        ‚Ä¢ R√©ussies : <strong>${counts.doneAll}</strong>/${counts.totalAll}
        ‚Ä¢ C≈ìurs aventure : <strong>‚ù§Ô∏è ${state.adventure.hearts}</strong>
        ‚Ä¢ Mots crois√©s gagn√©s : <strong>${state.crossword.wins}</strong>
      </div>

      <div class="mode-grid">
        <div class="mode-card">
          <div class="mode-top"><div class="mode-title">üìò Mode Classique</div></div>
          <div class="mode-desc">Choisis un th√®me et r√©ponds aux questions. Les bonnes r√©ponses sont exclues des cat√©gories (sauf Mixte).</div>
          <button class="btn" id="goClassic">‚ñ∂Ô∏è CLASSIQUE</button>
        </div>

        <div class="mode-card">
          <div class="mode-top"><div class="mode-title">üó∫Ô∏è Mode Aventure</div></div>
          <div class="mode-desc">Progresse niveau par niveau. Bonne r√©ponse = +1 ‚ù§Ô∏è, mauvaise = -1 ‚ù§Ô∏è (sans limite de gain). Niveau actuel : <strong>${lvl}</strong>.</div>
          <button class="btn gold" id="goAdventure">üó∫Ô∏è AVENTURE</button>
        </div>

        <div class="mode-card">
          <div class="mode-top"><div class="mode-title">üß© Mode Mots crois√©s</div></div>
          <div class="mode-desc">Grilles g√©n√©r√©es automatiquement depuis tes listes. Accents tol√©r√©s, espaces ignor√©s. +10 ü™ô si 100% correct. Joker = position du prochain mot (2 ü™ô).</div>
          <button class="btn" id="goCrossword">üß© MOTS CROIS√âS</button>
        </div>
      </div>

      <div class="row">
        <button class="btn secondary" id="btnWins">üìñ Mes r√©ussites</button>
        <button class="btn secondary" id="btnReset">üßº Reset (local)</button>
      </div>
    `;

    $("#goClassic").onclick = ()=> renderClassicHome();
    $("#goAdventure").onclick = ()=> renderAdventureMap();
    $("#goCrossword").onclick = ()=> renderCrosswordHome();
    $("#btnWins").onclick = ()=> renderSuccesses();
    $("#btnReset").onclick = ()=>{
      localStorage.removeItem(STORAGE_KEY);
      state = defaultState();
      renderModeMenu();
    };
  }

  /* ========= Successes ========= */
  function renderSuccesses(){
    updateTopBar();
    clearFooter();
    setHeartsVisible(false);

    const done = Object.keys(state.correctIds||{}).filter(id=>QUESTIONS.some(q=>q.id===id));
    const doneQs = done.map(id=>QUESTIONS.find(q=>q.id===id)).filter(Boolean);

    setHeader({type:"R√âUSSITES", theme:state.selectedTheme, diff:"‚Äî", counter:`${doneQs.length}/${QUESTIONS.length}`, media:"üèÜ", title:"Tes bonnes r√©ponses"});
    ui.trackDot.style.left = "50%";

    if(!doneQs.length){
      ui.gameArea.innerHTML = `
        <div class="hint">Aucune question r√©ussie pour le moment.</div>
        <button class="btn" id="back">‚¨ÖÔ∏è Retour</button>
      `;
      $("#back").onclick = ()=> renderModeMenu();
      return;
    }

    ui.gameArea.innerHTML = `
      <div class="hint">Liste des questions valid√©es (local).</div>
      <div class="order-zone" style="max-height: 320px; overflow:auto;">
        ${doneQs.map(q=>`
          <div style="padding:10px; border-bottom:1px solid rgba(191,230,255,.7);">
            <div style="font-weight:950">${esc(q.question)}</div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px;">‚úÖ ${esc(q.answer)} ‚Ä¢ ${esc(q.reference||"")}</div>
          </div>
        `).join("")}
      </div>
      <button class="btn" id="back">‚¨ÖÔ∏è Retour</button>
    `;
    $("#back").onclick = ()=> renderModeMenu();
  }

  /* ========= Classic ========= */
  function renderClassicHome(){
    updateTopBar();
    clearFooter();
    setHeartsVisible(false);

    setHeader({type:"CLASSIQUE", theme:state.selectedTheme, diff:"‚Äî", counter:"‚Äî", media:"üìò", title:"Choisis un th√®me"});
    ui.trackDot.style.left = "50%";

    const counts = computeCounts();

    ui.gameArea.innerHTML = `
      <div class="hint">En Mixte: toutes les questions. Dans une cat√©gorie: les questions d√©j√† r√©ussies sont retir√©es.</div>
      <div class="themes">
        ${THEMES.map(t=>{
          const c = t.key==="Mixte" ? {total:QUESTIONS.length, remaining:counts.remainingAll, done:counts.doneAll} : (counts.byTheme[t.key] || {total:0, remaining:0, done:0});
          return `
            <div class="theme-card ${state.selectedTheme===t.key?'selected':''}" data-key="${esc(t.key)}">
              <div class="t-top">
                <div class="t-name">${esc(t.label||t.key)}</div>
                <div class="t-ico">${esc(t.icon||"üìò")}</div>
              </div>
              <div class="t-sub">${esc(t.hint||"")}</div>
              <div class="t-sub"><strong>${c.done}</strong> valid√©es ‚Ä¢ <strong>${c.remaining}</strong> restantes ‚Ä¢ Total ${c.total}</div>
            </div>
          `;
        }).join("")}
      </div>

      <div class="row">
        <button class="btn gold" id="start">‚ñ∂Ô∏è D√©marrer</button>
        <button class="btn secondary" id="back">‚¨ÖÔ∏è Retour</button>
      </div>
    `;

    document.querySelectorAll(".theme-card").forEach(el=>{
      el.onclick = ()=>{
        const k = el.getAttribute("data-key");
        state.selectedTheme = k;
        saveState();
        renderClassicHome();
      };
    });

    $("#back").onclick = ()=> renderModeMenu();
    $("#start").onclick = ()=> startClassicSession();
  }

  function startClassicSession(){
    const theme = state.selectedTheme || "Mixte";
    const correct = state.correctIds || {};
    let pool = QUESTIONS.slice();

    if(theme !== "Mixte"){
      pool = pool.filter(q => (q.theme||"Bible") === theme && !correct[q.id]);
    }else{
      pool = QUESTIONS.slice(); // Mixte = tout
    }

    if(!pool.length){
      ui.footer.innerHTML = "‚ö†Ô∏è Plus de questions disponibles dans ce th√®me (toutes valid√©es).";
      return;
    }

    const ids = shuffle(pool).map(q=>q.id);
    state.session = { mode:"classic", ids, idx:0, usedJoker:false };
    saveState();
    renderQuestion();
  }

  /* ========= Adventure ========= */
  function renderAdventureMap(){
    updateTopBar();
    clearFooter();
    setHeartsVisible(true);

    const current = Math.max(1, Math.min(ADVENTURE_LEVELS.length, Number(state.adventure.currentLevel)||1));

    setHeader({type:"AVENTURE", theme:"‚Äî", diff:"‚Äî", counter:"‚Äî", media:"üó∫Ô∏è", title:"Carte d‚Äôaventure"});
    ui.trackDot.style.left = "50%";

    ui.gameArea.innerHTML = `
      <div class="adv-banner">
        <div class="big">‚ù§Ô∏è C≈ìurs : ${state.adventure.hearts}</div>
        <div class="small">Bonne r√©ponse = +1 ‚ù§Ô∏è ‚Ä¢ Mauvaise = -1 ‚ù§Ô∏è ‚Ä¢ (pas de limite de gain)</div>
      </div>

      <div class="map">
        ${ADVENTURE_LEVELS.map(l=>{
          const unlocked = l.n <= current;
          const doneStars = Number((state.adventure.levelStars||{})[l.n]||0);
          const lockTxt = unlocked ? "‚úÖ" : "üîí";
          return `
            <div class="lvl">
              <div class="lvl-head" data-lvl="${l.n}">
                <div class="lvl-left">
                  <div class="badge">${l.n}</div>
                  <div class="lvl-title">${esc(l.name)} ${l.boss ? "üëë" : ""}</div>
                </div>
                <div class="lvl-right">
                  <div class="stars">${doneStars ? ("‚≠ê".repeat(Math.min(5, doneStars))) : ""}</div>
                  <div class="lock">${lockTxt}</div>
                </div>
              </div>
              <div class="lvl-body" ${unlocked ? "" : "hidden"}>
                <div class="pill">Questions: <strong>${l.qCount}</strong></div>
                <div class="pill">Difficult√©: <strong>${l.minD}‚Äì${l.maxD}</strong></div>
                <button class="btn gold" data-start="${l.n}" ${unlocked ? "" : "disabled"}>‚ñ∂Ô∏è Jouer ce niveau</button>
              </div>
            </div>
          `;
        }).join("")}
      </div>

      <div class="row">
        <button class="btn secondary" id="back">‚¨ÖÔ∏è Retour</button>
      </div>
    `;

    document.querySelectorAll(".lvl-head").forEach(h=>{
      h.onclick = ()=>{
        const body = h.parentElement.querySelector(".lvl-body");
        if(body) body.hidden = !body.hidden;
      };
    });

    document.querySelectorAll("[data-start]").forEach(b=>{
      b.onclick = ()=>{
        const lvl = Number(b.getAttribute("data-start"));
        startAdventureLevel(lvl);
      };
    });

    $("#back").onclick = ()=> renderModeMenu();
  }

  function startAdventureLevel(levelN){
    const current = Math.max(1, Math.min(ADVENTURE_LEVELS.length, Number(state.adventure.currentLevel)||1));
    if(levelN > current) return;

    const cfg = ADVENTURE_LEVELS[levelN-1];
    const pool = QUESTIONS.filter(q=>{
      const d = Number(q.difficulty)||1;
      const t = (q.type||"QCM").toUpperCase();
      return d>=cfg.minD && d<=cfg.maxD && cfg.minTypes.includes(t);
    });

    if(!pool.length){
      ui.footer.innerHTML = "‚ö†Ô∏è Pas assez de questions pour ce niveau (filtrage trop strict).";
      return;
    }

    const ids = shuffle(pool).slice(0, cfg.qCount).map(q=>q.id);
    state.session = { mode:"adventure", level: levelN, ids, idx:0 };
    saveState();
    renderQuestion();
  }

  /* ========= Questions runner ========= */
  function currentQuestion(){
    const sid = state.session?.ids?.[state.session.idx];
    if(!sid) return null;
    return QUESTIONS.find(q=>q.id===sid) || null;
  }

  function renderQuestion(){
    updateTopBar();
    clearFooter();

    const q = currentQuestion();
    if(!q){
      if(state.session?.mode === "adventure") return endAdventureLevel(false);
      state.session = null;
      saveState();
      return renderClassicHome();
    }

    const total = state.session.ids.length;
    const idx = state.session.idx + 1;
    const type = (q.type||"QCM").toUpperCase();
    const diff = stars(q.difficulty||1);

    setHeader({
      type,
      theme: (q.theme||state.selectedTheme||"Mixte"),
      diff,
      counter: `${idx}/${total}`,
      media: pickMedia(q),
      title: q.question
    });

    ui.ref.style.display = q.reference ? "block" : "none";
    ui.ref.innerHTML = q.reference ? `üìå ${esc(q.reference)}` : "";

    ui.controls.style.display = "flex";
    ui.resultBox.style.display = "none";

    const inClassic = state.session.mode === "classic";
    ui.btnJoker.style.display = inClassic ? "block" : "none";

    ui.btnSkip.onclick = ()=>{
      state.session.idx++;
      saveState();
      renderQuestion();
    };
    ui.btnEnd.onclick = ()=>{
      if(state.session.mode === "adventure") return endAdventureLevel(true);
      state.session = null;
      saveState();
      renderClassicHome();
    };

    ui.btnJoker.onclick = ()=>{
      if(!inClassic) return;
      if(state.session.usedJoker){
        ui.footer.innerHTML = "‚ö†Ô∏è Joker d√©j√† utilis√© dans cette session.";
        return;
      }
      if(state.coins < JOKER_COST){
        ui.footer.innerHTML = "‚ö†Ô∏è Pas assez de pi√®ces.";
        return;
      }
      state.coins -= JOKER_COST;
      state.session.usedJoker = true;
      saveState();
      updateTopBar();
      applyJokerRemoveOptions(q);
    };

    if(type === "ORDRE"){
      renderOrderQuestion(q);
    }else if(type === "TROU"){
      renderFillBlankQuestion(q);
    }else{
      renderChoiceQuestion(q);
    }
  }

  function awardAfterAnswer(isGood, q){
    if(isGood){
      state.coins += COINS_PER_GOOD;
      state.correctIds[q.id] = true;
    }
    if(state.session?.mode === "adventure"){
      if(isGood) state.adventure.hearts += 1;
      else state.adventure.hearts = Math.max(0, state.adventure.hearts - 1);
    }
    saveState();
    updateTopBar();
  }

  function showResult(isGood, q, extraSmall=""){
    ui.resultBox.style.display = "block";
    ui.resultBox.className = "result " + (isGood ? "good":"bad");
    ui.resultBox.innerHTML = `
      <div class="title">${isGood ? "‚úÖ Bonne r√©ponse !" : "‚ùå Mauvaise r√©ponse"}</div>
      <div class="small"><strong>R√©ponse :</strong> ${esc(q.answer)}${q.reference ? `<br><strong>R√©f√©rence :</strong> ${esc(q.reference)}` : ""}${extraSmall ? `<br>${extraSmall}` : ""}</div>
    `;
  }

  function nextAfterDelay(){
    setTimeout(()=>{
      state.session.idx++;
      saveState();
      renderQuestion();
    }, 550);
  }

  /* QCM/VF */
  function buildOptionsFor(q){
    const type = (q.type||"QCM").toUpperCase();
    if(Array.isArray(q.options) && q.options.length){
      const opts = q.options.slice();
      if(!opts.some(x=>normalize(x)===normalize(q.answer))) opts.push(q.answer);
      return shuffle(opts);
    }
    if(type==="VF") return ["Vrai","Faux"];
    return shuffle([q.answer, "‚Äî", "‚Äî", "‚Äî"]).filter(Boolean);
  }

  let lastChoiceButtons = [];
  function renderChoiceQuestion(q){
    const opts = buildOptionsFor(q);

    ui.gameArea.innerHTML = `
      <div class="answers">
        ${opts.map(o=>`<button class="ansbtn" data-ans="${esc(o)}">${esc(o)}</button>`).join("")}
      </div>
    `;

    lastChoiceButtons = Array.from(document.querySelectorAll(".ansbtn"));

    lastChoiceButtons.forEach(btn=>{
      btn.onclick = ()=>{
        const chosen = btn.getAttribute("data-ans");
        const good = normalize(chosen) === normalize(q.answer);

        lastChoiceButtons.forEach(b=>b.disabled=true);

        if(good){
          btn.classList.add("correct");
          awardAfterAnswer(true, q);
          showResult(true, q);
        }else{
          btn.classList.add("wrong");
          lastChoiceButtons.forEach(b=>{
            if(normalize(b.getAttribute("data-ans")) === normalize(q.answer)) b.classList.add("correct");
          });
          awardAfterAnswer(false, q);
          showResult(false, q);
        }
        nextAfterDelay();
      };
    });
  }

  function applyJokerRemoveOptions(q){
    if(!lastChoiceButtons?.length){
      ui.footer.innerHTML = "‚ö†Ô∏è Joker dispo seulement sur QCM/VF.";
      return;
    }
    let removed = 0;
    for(const b of lastChoiceButtons){
      if(removed>=2) break;
      const val = b.getAttribute("data-ans");
      if(normalize(val) !== normalize(q.answer)){
        b.disabled = true;
        b.style.opacity = "0.35";
        removed++;
      }
    }
    ui.footer.innerHTML = "üÉè Joker utilis√© : 2 mauvaises r√©ponses retir√©es.";
  }

  /* TROU */
  function renderFillBlankQuestion(q){
    ui.gameArea.innerHTML = `
      <div class="form">
        <div class="field">
          <div class="label">Ta r√©ponse</div>
          <input class="input" id="inpFill" placeholder="√âcris le mot..." />
        </div>
        <button class="btn gold" id="submit">‚úÖ Valider</button>
      </div>
    `;
    const inp = $("#inpFill");
    inp.focus();

    $("#submit").onclick = ()=>{
      const val = (inp.value||"").trim();
      const good = normalize(val) === normalize(q.answer);
      $("#submit").disabled = true;
      inp.disabled = true;

      awardAfterAnswer(good, q);
      showResult(good, q);
      nextAfterDelay();
    };
  }

  /* ORDRE */
  function renderOrderQuestion(q){
    const target = splitOrderAnswer(q.answer);
    const pool = shuffle(target);

    let chosen = [];
    function draw(){
      ui.gameArea.innerHTML = `
        <div class="order-wrap">
          <div class="order-zone">
            <div class="order-title">Clique les √©l√©ments dans le bon ordre</div>
            <div class="chips" id="pool">
              ${pool.map((w,i)=>`<button class="chipbtn" data-i="${i}" ${chosen.includes(i) ? "disabled":""}>${esc(w)}</button>`).join("")}
            </div>
          </div>

          <div class="order-zone">
            <div class="order-title">Ton ordre</div>
            <div class="chips" id="pick">
              ${chosen.map(i=>`<span class="pill">${esc(pool[i])}</span>`).join("") || `<span class="hint">‚Äî</span>`}
            </div>
          </div>

          <div class="row">
            <button class="btn secondary" id="undo" ${chosen.length? "":"disabled"}>‚Ü©Ô∏è Annuler</button>
            <button class="btn gold" id="submit" ${chosen.length===target.length? "":"disabled"}>‚úÖ Valider</button>
          </div>
        </div>
      `;

      document.querySelectorAll(".chipbtn").forEach(b=>{
        b.onclick = ()=>{
          const i = Number(b.getAttribute("data-i"));
          if(chosen.includes(i)) return;
          chosen.push(i);
          draw();
        };
      });

      $("#undo").onclick = ()=>{
        chosen.pop();
        draw();
      };

      $("#submit").onclick = ()=>{
        const attempt = chosen.map(i=>pool[i]);
        const good = attempt.map(normalize).join("|") === target.map(normalize).join("|");
        awardAfterAnswer(good, q);
        showResult(good, q, good ? "‚≠ê Bien jou√© !" : "üí° Astuce : relis la liste et recommence au prochain.");
        nextAfterDelay();
      };
    }
    draw();
  }

  function endAdventureLevel(force=false){
    const sess = state.session;
    if(!sess || sess.mode!=="adventure"){
      state.session = null;
      saveState();
      return renderModeMenu();
    }

    const total = sess.ids.length;
    const answered = Math.min(total, Math.max(0, sess.idx));
    const ratio = total ? (answered/total) : 0;
    const starsEarned = ratio >= .9 ? 5 : ratio >= .75 ? 4 : ratio >= .6 ? 3 : ratio >= .4 ? 2 : 1;

    const lvl = sess.level || 1;
    state.adventure.levelStars[lvl] = Math.max(Number(state.adventure.levelStars[lvl]||0), starsEarned);

    if(!force){
      state.adventure.currentLevel = Math.max(state.adventure.currentLevel, Math.min(ADVENTURE_LEVELS.length, lvl+1));
    }

    state.session = null;
    saveState();

    updateTopBar();
    clearFooter();
    setHeartsVisible(true);

    setHeader({type:"AVENTURE", theme:"‚Äî", diff:"‚Äî", counter:"‚Äî", media:"üèÅ", title:`Niveau ${lvl} termin√©`});
    ui.trackDot.style.left = "50%";

    ui.gameArea.innerHTML = `
      <div class="result good">
        <div class="title">‚≠ê √âtoiles gagn√©es : ${"‚≠ê".repeat(starsEarned)}</div>
        <div class="small">C≈ìurs actuels : ‚ù§Ô∏è ${state.adventure.hearts}</div>
      </div>
      <div class="row">
        <button class="btn gold" id="backMap">üó∫Ô∏è Retour carte</button>
        <button class="btn secondary" id="home">üè† Accueil</button>
      </div>
    `;
    $("#backMap").onclick = ()=> renderAdventureMap();
    $("#home").onclick = ()=> renderModeMenu();
  }

  /* ========= Mots crois√©s ========= */
  function getSelectedBank(){
    const key = state.crossword.selectedBank;
    return CROSSWORD_BANKS.find(b=>b.key===key) || CROSSWORD_BANKS[0] || null;
  }

  function renderCrosswordHome(){
    updateTopBar();
    clearFooter();
    setHeartsVisible(false);

    setHeader({type:"MOTS CROIS√âS", theme:"‚Äî", diff:"‚Äî", counter:"‚Äî", media:"üß©", title:"Choisis une grille"});
    ui.trackDot.style.left = "50%";

    ui.gameArea.innerHTML = `
      <div class="hint">
        Les mots crois√©s vont vous donner le plaisir de lire la Bible diff√©remment car pour ce mode de jeu ci, votre Bible vous sera tr√®s utile. Bon amusement.<br>
        <strong>Grille g√©n√©r√©e automatiquement depuis ta liste.</strong> ‚Ä¢ Accents tol√©r√©s (√â = E) ‚Ä¢ Espaces ignor√©s (ex: ‚Äú√âMU DE PITI√â‚Äù = une seule entr√©e)
      </div>

      <div class="form">
        <div class="field">
          <div class="label">Grille</div>
          <select class="input" id="bankSel">
            ${CROSSWORD_BANKS.map(b=>`<option value="${esc(b.key)}" ${b.key===state.crossword.selectedBank?"selected":""}>${esc(b.title)} ‚Äî ${esc(b.subtitle||"")}</option>`).join("")}
          </select>
        </div>
        <button class="btn gold" id="startXW">‚ñ∂Ô∏è D√©marrer la grille</button>
        <button class="btn secondary" id="back">‚¨ÖÔ∏è Retour</button>
      </div>
    `;

    $("#bankSel").onchange = (e)=>{
      state.crossword.selectedBank = e.target.value;
      saveState();
    };
    $("#startXW").onclick = ()=> startCrossword();
    $("#back").onclick = ()=> renderModeMenu();
  }

  function startCrossword(){
    const bank = getSelectedBank();
    if(!bank || !bank.items?.length){
      ui.footer.innerHTML = "‚ö†Ô∏è Grille vide.";
      return;
    }

    const entries = bank.items.map((it, idx)=>({
      id: it.id || ("xw_"+idx),
      clue: it.clue || "",
      answerRaw: it.answer || "",
      answer: normalizeLettersOnly(it.answer || "")
    })).filter(e=>e.answer.length>=2);

    entries.sort((a,b)=>b.answer.length - a.answer.length);

    const gridSize = Math.max(13, Math.min(19, Math.max(...entries.map(e=>e.answer.length)) + 4));
    const grid = Array.from({length:gridSize}, ()=>Array.from({length:gridSize}, ()=>null));
    const placed = [];

    function canPlace(word, r, c, dir){
      for(let i=0;i<word.length;i++){
        const rr = r + (dir==='D'?i:0);
        const cc = c + (dir==='A'?i:0);
        if(rr<0||cc<0||rr>=gridSize||cc>=gridSize) return false;
        const cur = grid[rr][cc];
        if(cur && cur !== word[i]) return false;
      }
      return true;
    }

    function placeWord(entry, r, c, dir){
      for(let i=0;i<entry.answer.length;i++){
        const rr = r + (dir==='D'?i:0);
        const cc = c + (dir==='A'?i:0);
        grid[rr][cc] = entry.answer[i];
      }
      placed.push({entry, r, c, dir});
    }

    const first = entries[0];
    const r0 = Math.floor(gridSize/2);
    const c0 = Math.floor((gridSize - first.answer.length)/2);
    placeWord(first, r0, c0, 'A');

    for(let k=1;k<entries.length;k++){
      const entry = entries[k];
      let ok = false;

      for(let pi=0; pi<placed.length && !ok; pi++){
        const p = placed[pi];
        const w = p.entry.answer;

        for(let i=0;i<entry.answer.length && !ok;i++){
          const ch = entry.answer[i];

          for(let j=0;j<w.length && !ok;j++){
            if(w[j] !== ch) continue;

            const rr = p.r + (p.dir==='D'?j:0);
            const cc = p.c + (p.dir==='A'?j:0);

            const dir = (p.dir==='A') ? 'D' : 'A';
            const r = rr - (dir==='D'?i:0);
            const c = cc - (dir==='A'?i:0);

            if(canPlace(entry.answer, r, c, dir)){
              placeWord(entry, r, c, dir);
              ok = true;
            }
          }
        }
      }

      if(!ok){
        for(let tries=0; tries<250 && !ok; tries++){
          const dir = Math.random()<0.5?'A':'D';
          const r = Math.floor(Math.random()*gridSize);
          const c = Math.floor(Math.random()*gridSize);
          if(canPlace(entry.answer, r, c, dir)){
            placeWord(entry, r, c, dir);
            ok = true;
          }
        }
      }
    }

    let minR=gridSize, minC=gridSize, maxR=0, maxC=0;
    for(let r=0;r<gridSize;r++){
      for(let c=0;c<gridSize;c++){
        if(grid[r][c]){
          minR=Math.min(minR,r); minC=Math.min(minC,c);
          maxR=Math.max(maxR,r); maxC=Math.max(maxC,c);
        }
      }
    }
    minR=Math.max(0,minR-1); minC=Math.max(0,minC-1);
    maxR=Math.min(gridSize-1,maxR+1); maxC=Math.min(gridSize-1,maxC+1);

    const H = maxR-minR+1;
    const W = maxC-minC+1;

    const cropped = Array.from({length:H}, (_,rr)=>Array.from({length:W}, (_,cc)=>grid[minR+rr][minC+cc]));
    const placements = placed.map(p=>({
      id: p.entry.id,
      clue: p.entry.clue,
      answer: p.entry.answer,
      dir: p.dir,
      r: p.r - minR,
      c: p.c - minC,
      len: p.entry.answer.length
    }));

    const nums = Array.from({length:H}, ()=>Array.from({length:W}, ()=>0));
    let num=1;
    const across = [];
    const down = [];

    function isLetter(rr,cc){ return !!cropped[rr]?.[cc]; }
    function startsAcross(rr,cc){
      if(!isLetter(rr,cc)) return false;
      const left = cc===0 ? false : isLetter(rr,cc-1);
      const right = cc+1<W ? isLetter(rr,cc+1) : false;
      return (!left && right);
    }
    function startsDown(rr,cc){
      if(!isLetter(rr,cc)) return false;
      const up = rr===0 ? false : isLetter(rr-1,cc);
      const downn = rr+1<H ? isLetter(rr+1,cc) : false;
      return (!up && downn);
    }

    const byStart = new Map();
    for(const pl of placements){
      byStart.set(`${pl.r},${pl.c},${pl.dir}`, pl);
    }

    for(let r=0;r<H;r++){
      for(let c=0;c<W;c++){
        const a = startsAcross(r,c);
        const d = startsDown(r,c);
        if(a || d){
          nums[r][c] = num;

          if(a){
            const pl = byStart.get(`${r},${c},A`);
            if(pl) across.push({n:num, clue: pl.clue, id: pl.id, len: pl.len});
          }
          if(d){
            const pl = byStart.get(`${r},${c},D`);
            if(pl) down.push({n:num, clue: pl.clue, id: pl.id, len: pl.len});
          }
          num++;
        }
      }
    }

    const user = Array.from({length:H}, ()=>Array.from({length:W}, ()=>""));
    state.session = { mode:"crossword", xw:{H,W,grid:cropped,nums,across,down,user} };
    saveState();
    renderCrosswordGame();
  }

  function renderCrosswordGame(){
    updateTopBar();
    clearFooter();
    setHeartsVisible(false);

    const xw = state.session?.xw;
    if(!xw){ return renderCrosswordHome(); }

    setHeader({type:"MOTS CROIS√âS", theme:"‚Äî", diff:"‚Äî", counter:"", media:"üß©", title:"Compl√®te la grille"});
    ui.trackDot.style.left = "50%";

    const {H,W,grid,nums,across,down,user} = xw;

    ui.gameArea.innerHTML = `
      <div class="xw-wrap">
        <div class="xw-toprow">
          <div class="xw-stats">
            <span class="pill">Cases: <strong>${H*W}</strong></span>
            <span class="pill">Mots: <strong>${across.length + down.length}</strong></span>
          </div>
          <div class="row" style="margin:0;">
            <button class="btn secondary" id="xwBack" style="margin:0; min-width:120px;">‚¨ÖÔ∏è Retour</button>
            <button class="btn" id="xwJoker" style="margin:0; min-width:120px;">üÉè Joker (2 ü™ô)</button>
            <button class="btn gold" id="xwCheck" style="margin:0; min-width:120px;">‚úÖ V√©rifier</button>
          </div>
        </div>

        <div class="xw-grid" id="xwGrid" style="grid-template-columns: repeat(${W}, 1fr);">
          ${Array.from({length:H}, (_,r)=>Array.from({length:W}, (_,c)=>{
            if(!grid[r][c]) return `<div class="xw-cell block"></div>`;
            const n = nums[r][c] ? `<div class="num">${nums[r][c]}</div>` : "";
            const val = esc(user[r][c]||"");
            return `
              <div class="xw-cell" data-r="${r}" data-c="${c}">
                ${n}
                <input maxlength="1" inputmode="text" value="${val}" />
              </div>
            `;
          }).join("")).join("")}
        </div>

        <div class="xw-clues">
          <div class="xw-panel">
            <h3>‚û°Ô∏è Horizontal</h3>
            <div class="xw-cluelist">
              ${across.map(it=>`<div class="xw-clue"><span class="n">${it.n}.</span> ${esc(it.clue)}</div>`).join("") || `<div class="xw-footnote">‚Äî</div>`}
            </div>
          </div>
          <div class="xw-panel">
            <h3>‚¨áÔ∏è Vertical</h3>
            <div class="xw-cluelist">
              ${down.map(it=>`<div class="xw-clue"><span class="n">${it.n}.</span> ${esc(it.clue)}</div>`).join("") || `<div class="xw-footnote">‚Äî</div>`}
            </div>
          </div>
        </div>

        <div class="xw-footnote">
          Grille g√©n√©r√©e automatiquement depuis ta liste. ‚Ä¢ Accents tol√©r√©s (√â = E) ‚Ä¢ Espaces ignor√©s (ex: ‚Äú√âMU DE PITI√â‚Äù = une seule entr√©e)
        </div>
      </div>
    `;

    $("#xwBack").onclick = ()=>{
      state.session = null;
      saveState();
      renderCrosswordHome();
    };

    // inputs
    document.querySelectorAll("#xwGrid .xw-cell input").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const cell = inp.closest(".xw-cell");
        if(!cell) return;
        const r = Number(cell.getAttribute("data-r"));
        const c = Number(cell.getAttribute("data-c"));
        const ch = normalizeLettersOnly(inp.value || "");
        inp.value = ch ? ch[0] : "";
        xw.user[r][c] = inp.value;
        saveState();

        if(inp.value){
          const next = cell.nextElementSibling;
          if(next && next.classList.contains("xw-cell") && !next.classList.contains("block")){
            const ni = next.querySelector("input");
            if(ni) ni.focus();
          }
        }
      });
    });

    // -------- Joker crossword : position du mot suivant --------
    function wordSolved(pl){
      for(let i=0;i<pl.len;i++){
        const rr = pl.r + (pl.dir==='D'?i:0);
        const cc = pl.c + (pl.dir==='A'?i:0);
        const expected = grid[rr][cc];
        const got = (xw.user[rr][cc]||"").toUpperCase();
        if(got !== expected) return false;
      }
      return true;
    }

    function getPlacementsFromGrid(){
      const placements = [];
      function isLetter(rr,cc){ return !!grid[rr]?.[cc]; }

      // Across
      for(let r=0;r<H;r++){
        for(let c=0;c<W;c++){
          if(!isLetter(r,c)) continue;
          const left = (c>0) ? isLetter(r,c-1) : false;
          const right = (c+1<W) ? isLetter(r,c+1) : false;
          if(!left && right){
            let len=1;
            while(c+len<W && isLetter(r,c+len)) len++;
            placements.push({ r, c, dir:'A', len });
          }
        }
      }
      // Down
      for(let r=0;r<H;r++){
        for(let c=0;c<W;c++){
          if(!isLetter(r,c)) continue;
          const up = (r>0) ? isLetter(r-1,c) : false;
          const downn = (r+1<H) ? isLetter(r+1,c) : false;
          if(!up && downn){
            let len=1;
            while(r+len<H && isLetter(r+len,c)) len++;
            placements.push({ r, c, dir:'D', len });
          }
        }
      }
      return placements;
    }

    function clearHint(){
      document.querySelectorAll("#xwGrid .xw-cell.hint").forEach(el=>el.classList.remove("hint"));
    }

    function hintPlacement(pl){
      clearHint();
      const cell = document.querySelector(`#xwGrid .xw-cell[data-r="${pl.r}"][data-c="${pl.c}"]`);
      if(cell){
        cell.classList.add("hint");
        const inp = cell.querySelector("input");
        if(inp) inp.focus();
      }

      const n = (nums[pl.r][pl.c]||"?");
      const dirTxt = pl.dir === 'A' ? "Horizontal ‚û°Ô∏è" : "Vertical ‚¨áÔ∏è";

      ui.footer.innerHTML = `üÉè Position du mot suivant : <strong>${n}</strong> (${dirTxt}) ‚Äî d√©part sur la case surlign√©e.`;
      setTimeout(()=>{ clearHint(); }, 2500);
    }

    $("#xwJoker").onclick = ()=>{
      const cost = 2;
      if(state.coins < cost){
        ui.footer.innerHTML = "‚ö†Ô∏è Pas assez de pi√®ces pour le joker.";
        return;
      }

      const placements = getPlacementsFromGrid();
      placements.sort((p1,p2)=>{
        const n1 = nums[p1.r][p1.c] || 9999;
        const n2 = nums[p2.r][p2.c] || 9999;
        if(n1!==n2) return n1-n2;
        if(p1.dir!==p2.dir) return (p1.dir==='A' ? -1 : 1);
        return 0;
      });

      const next = placements.find(pl => !wordSolved(pl));
      if(!next){
        ui.footer.innerHTML = "‚úÖ Tous les mots semblent d√©j√† compl√©t√©s. (Tu peux v√©rifier !)";
        return;
      }

      state.coins -= cost;
      saveState();
      updateTopBar();
      hintPlacement(next);
    };
    // ----------------------------------------------------------

    $("#xwCheck").onclick = ()=>{
      let totalLetters=0, goodLetters=0;
      document.querySelectorAll("#xwGrid .xw-cell").forEach(cell=>{
        cell.classList.remove("bad","good");
        if(cell.classList.contains("block")) return;
        const r = Number(cell.getAttribute("data-r"));
        const c = Number(cell.getAttribute("data-c"));
        const expected = grid[r][c];
        const got = (xw.user[r][c]||"").toUpperCase();
        totalLetters++;
        if(got && got === expected){
          goodLetters++;
          cell.classList.add("good");
        }else{
          if(got) cell.classList.add("bad");
        }
      });

      const pct = totalLetters ? Math.round((goodLetters/totalLetters)*100) : 0;

      ui.resultBox.style.display = "block";
      ui.resultBox.className = "result " + (pct===100 ? "good":"bad");
      ui.resultBox.innerHTML = `
        <div class="title">${pct===100 ? "üéâ Grille compl√®te !" : "üîé R√©sultat"}</div>
        <div class="small">Lettres correctes : <strong>${goodLetters}</strong> / ${totalLetters} (${pct}%).</div>
      `;

      if(pct === 100){
        state.coins += 10;
        state.crossword.wins += 1;
        updateTopBar();
        saveState();
      }
    };
  }

  /* ========= Boot ========= */
  function boot(){
    if(!THEMES.length || !QUESTIONS.length){
      setHeader({type:"ERREUR", theme:"‚Äî", diff:"‚Äî", counter:"‚Äî", media:"‚ö†Ô∏è", title:"Donn√©es introuvables"});
      ui.gameArea.innerHTML = `
        <div class="hint">
          Je ne trouve pas <strong>questions.js</strong> (ou il est vide).<br>
          Mets <strong>index.html</strong>, <strong>questions.js</strong>, <strong>crosswords.js</strong> dans le m√™me dossier.
        </div>
      `;
      return;
    }

    updateTopBar();
    if(!state.profile) renderProfileGate();
    else if(state.session?.mode === "crossword") renderCrosswordGame();
    else if(state.session?.ids?.length) renderQuestion();
    else renderModeMenu();
  }
  boot();
  </script>
</body>
</html>
