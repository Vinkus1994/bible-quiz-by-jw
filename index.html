

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JW Quiz</title>
  <style>
    :root{
      --sky1:#4cc3ff;
      --sky2:#2a8dff;
      --bg:#eaf6ff;
      --panel:#ffffff;
      --panel2:#f5fbff;
      --line:#bfe6ff;
      --ink:#12304a;
      --muted:#4f6b86;
      --shadow: 0 14px 30px rgba(0,0,0,.14);
      --shadowSoft: 0 10px 18px rgba(0,0,0,.10);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 650px at 20% 0%, rgba(255,255,255,.65), transparent 55%),
        radial-gradient(900px 650px at 90% 10%, rgba(255,255,255,.45), transparent 55%),
        linear-gradient(180deg, var(--sky1), var(--sky2) 35%, var(--bg) 35%, var(--bg));
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:14px;
      color:var(--ink);
    }
    .wrap{width:min(460px, 100%);}

    .hud{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.22);
      border:1px solid rgba(255,255,255,.40);
      box-shadow: var(--shadow);
      color:#fff;
      backdrop-filter: blur(8px);
    }
    .hud-center{
      font-weight:950;
      letter-spacing:.2px;
      text-shadow: 0 2px 10px rgba(0,0,0,.15);
      user-select:none;
      cursor:pointer;
    }
    .hud-right{display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap}
    .hud-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.35);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      user-select:none;
    }
    .hud-pill strong{ font-variant-numeric: tabular-nums; }

    .track{ position:relative; margin:12px 0 14px; height:48px; }
    .track-line{
      position:absolute; left:18px; right:18px; top:50%;
      height:10px; transform:translateY(-50%);
      background: rgba(255,255,255,.65);
      border:1px solid rgba(255,255,255,.95);
      border-radius:999px;
      box-shadow: inset 0 2px 6px rgba(0,0,0,.10);
    }
    .track-dot{
      position:absolute; top:50%;
      width:18px;height:18px; transform:translate(-50%,-50%);
      border-radius:999px;
      background:#ffe27a;
      border:2px solid rgba(255,255,255,.98);
      box-shadow: 0 6px 14px rgba(0,0,0,.16);
      transition:left .2s ease;
    }
    .avatar{
      position:absolute; top:50%;
      width:36px; height:36px; transform:translateY(-50%);
      border-radius:999px;
      background: rgba(255,255,255,.96);
      border:1px solid rgba(0,0,0,.08);
      display:grid; place-items:center;
      box-shadow: 0 10px 18px rgba(0,0,0,.14);
      font-size:18px; user-select:none;
    }
    .avatar.left{left:0}
    .avatar.right{right:0}

    .card{
      position:relative;
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateZ(0);
    }
    .card-top{
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(58,166,255,.14), rgba(58,166,255,.04));
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(58,166,255,.08);
      color: var(--muted);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .tag strong{color:var(--ink)}
    .counter{ font-size:12px; color:var(--muted); font-weight:900; white-space:nowrap; }

    .qarea{
      padding:14px;
      display:grid;
      grid-template-columns: 82px 1fr;
      gap:12px;
      align-items:center;
      background: linear-gradient(180deg, #ffffff, var(--panel2));
    }
    .qmedia{
      width:82px; height:82px;
      border-radius: 14px;
      background: #f2fbff;
      border: 1px dashed #a9dcff;
      display:grid;
      place-items:center;
      font-size:32px;
      user-select:none;
    }
    .qtext{ font-size:16px; font-weight:950; line-height:1.2; }

    .ref{
      padding:0 14px 12px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      display:none;
    }

    .btn{
      width:100%;
      margin-top:12px;
      padding:14px 12px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.10);
      background: linear-gradient(180deg, #ffffff, #eaf7ff);
      font-size:16px;
      font-weight:950;
      color:var(--ink);
      box-shadow: var(--shadowSoft);
      cursor:pointer;
      user-select:none;
      text-align:center;
      transition: transform .06s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .btn:hover{ box-shadow: 0 14px 26px rgba(0,0,0,.12); border-color: rgba(58,166,255,.35); }
    .btn:active{ transform: scale(.99); }
    .btn[disabled]{opacity:.55; cursor:not-allowed;}
    .btn.secondary{ background: linear-gradient(180deg, #ffffff, #f3fbff); }
    .btn.gold{ background: linear-gradient(180deg, #fff8d9, #ffeaa9); }

    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .row .btn{flex:1; min-width:140px; margin-top:0;}

    .answers{margin-top:12px; display:grid; gap:10px;}
    .ansbtn{
      width:100%;
      text-align:center;
      padding:14px 12px;
      font-size:16px;
      font-weight:950;
      color:var(--ink);
      border-radius: 14px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff, #eaf7ff);
      box-shadow: var(--shadowSoft);
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .ansbtn:hover{border-color: rgba(58,166,255,.35); box-shadow: 0 14px 26px rgba(0,0,0,.12);}
    .ansbtn:active{transform: scale(.99)}
    .ansbtn[disabled]{opacity:.55; cursor:not-allowed}
    .ansbtn.correct{border-color: rgba(26,165,106,.45); background: rgba(26,165,106,.08);}
    .ansbtn.wrong{border-color: rgba(229,72,93,.45); background: rgba(229,72,93,.07);}

    .order-wrap{margin-top:12px; display:grid; gap:10px;}
    .order-zone{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:10px;
      box-shadow: var(--shadowSoft);
    }
    .order-title{
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      margin:0 0 8px 0;
    }
    .chips{display:flex; flex-wrap:wrap; gap:8px;}
    .chipbtn{
      border:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff, #f2fbff);
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      color:var(--ink);
      cursor:pointer;
      box-shadow: 0 10px 16px rgba(0,0,0,.08);
      user-select:none;
    }
    .chipbtn[disabled]{opacity:.45; cursor:not-allowed}

    .result{
      margin-top:12px;
      padding:12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
    }
    .result.good{border-color: rgba(26,165,106,.35); background: rgba(26,165,106,.06)}
    .result.bad{border-color: rgba(229,72,93,.35); background: rgba(229,72,93,.05)}
    .result .title{font-weight:950}
    .result .small{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35}

    .controls{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;}
    .ctrl{
      flex:1; min-width:140px;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:950;
      color:var(--ink);
      box-shadow: var(--shadowSoft);
      cursor:pointer;
      user-select:none;
      text-align:center;
    }
    .ctrl.danger{
      border-color: rgba(229,72,93,.25);
      background: rgba(229,72,93,.06);
    }
    .ctrl.gold{
      border-color: rgba(255,206,92,.55);
      background: rgba(255,206,92,.18);
    }

    .form{ display:grid; gap:10px; margin-top:12px; }
    .field{ display:grid; gap:6px; }
    .label{ font-size:12px; font-weight:900; color:var(--muted); }
    .input{
      width:100%;
      padding:14px 12px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.10);
      background: linear-gradient(180deg, #ffffff, #f3fbff);
      font-weight:950;
      color:var(--ink);
      outline:none;
      box-shadow: var(--shadowSoft);
      transition: box-shadow .18s ease, border-color .18s ease;
    }
    .input:focus{
      border-color: rgba(58,166,255,.45);
      box-shadow: 0 14px 26px rgba(0,0,0,.12);
    }
    .hint{ font-size:12px; color:var(--muted); line-height:1.35; }

    .themes{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .theme-card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff, #f3fbff);
      border-radius: 16px;
      padding:12px;
      box-shadow: var(--shadowSoft);
      cursor:pointer;
      user-select:none;
      text-align:left;
      transition: transform .06s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .theme-card:hover{
      border-color: rgba(58,166,255,.35);
      box-shadow: 0 14px 26px rgba(0,0,0,.12);
    }
    .theme-card:active{ transform: scale(.99); }
    .theme-card.selected{
      border-color: rgba(26,165,106,.35);
      background: linear-gradient(180deg, rgba(26,165,106,.08), #ffffff);
    }
    .theme-card .t-top{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .theme-card .t-ico{ font-size:18px; }
    .theme-card .t-name{ font-weight:950; }
    .theme-card .t-sub{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.25; }

    /* Aventure */
    .adv-banner{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,204,77,.20), rgba(255,204,77,.06));
      box-shadow: var(--shadowSoft);
    }
    .adv-banner .big{font-weight:950}
    .adv-banner .small{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35}

    .map{ margin-top:12px; display:grid; gap:10px; }
    .lvl{
      border:1px solid var(--line);
      border-radius: 16px;
      background: #fff;
      box-shadow: var(--shadowSoft);
      overflow:hidden;
    }
    .lvl-head{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(58,166,255,.10), rgba(58,166,255,.03));
      cursor:pointer;
      user-select:none;
    }
    .lvl-left{display:flex; align-items:center; gap:10px; min-width:0;}
    .badge{
      width:34px;height:34px;
      border-radius:12px;
      display:grid; place-items:center;
      border:1px solid rgba(0,0,0,.08);
      background: linear-gradient(180deg,#fff,#f2fbff);
      box-shadow: 0 10px 16px rgba(0,0,0,.08);
      font-weight:950;
    }
    .lvl-title{
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .lvl-right{display:flex; align-items:center; gap:10px; flex:0 0 auto;}
    .stars{font-weight:950; color:#946200; white-space:nowrap;}
    .lock{font-weight:950; color:var(--muted)}
    .lvl-body{
      padding:10px 12px 12px;
      display:grid;
      gap:8px;
      background: linear-gradient(180deg, #fff, #f7fcff);
    }
    .lvl-body[hidden]{display:none}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(191,230,255,.95);
      background: rgba(58,166,255,.06);
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      width:max-content;
    }
    .pill strong{color:var(--ink)}

    /* Menu Modes */
    .mode-grid{ margin-top:12px; display:grid; gap:10px; }
    .mode-card{
      border:1px solid var(--line);
      border-radius: 18px;
      background: #fff;
      box-shadow: var(--shadowSoft);
      padding:12px;
      display:grid;
      gap:10px;
    }
    .mode-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .mode-title{
      font-weight:950;
      display:flex;
      align-items:center;
      gap:10px;
      font-size:16px;
    }
    .mode-desc{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    /* ===== Mots crois√©s ===== */
    .xw-wrap{
      margin-top:12px;
      display:grid;
      gap:12px;
    }
    .xw-toprow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .xw-stats{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .xw-grid{
      border:1px solid var(--line);
      border-radius: 16px;
      overflow:auto;                  /* ‚úÖ scroll si trop large */
      box-shadow: var(--shadowSoft);
      background:#fff;
      display:grid;
      gap:6px;
      padding:10px;
      max-width:100%;
    }

    .xw-cell{
      position:relative;
      background:#f6fbff;
      border:1px solid rgba(191,230,255,.65);
      width:46px;                     /* ‚úÖ taille PC */
      height:46px;
      display:grid;
      place-items:center;
      overflow:hidden;
      border-radius:10px;
    }

    @media (max-width: 480px){
      .xw-cell{
        width:36px;                   /* ‚úÖ mobile */
        height:36px;
      }
    }

    .xw-cell.block{
      background: #1b3d5a;
      border-color: rgba(0,0,0,.10);
    }
    .xw-cell input{
      width:100%;
      height:100%;
      border:0;
      outline:none;
      background:transparent;
      text-align:center;
      font-weight:950;
      font-size:16px;
      color:var(--ink);
      text-transform: uppercase;
      caret-color: transparent;
    }
    .xw-cell input::selection{ background: rgba(58,166,255,.25); }
    .xw-cell .num{
      position:absolute;
      top:2px; left:3px;
      font-size:10px;
      font-weight:950;
      color: rgba(18,48,74,.72);
      user-select:none;
      pointer-events:none;
    }
    .xw-cell.selected{
      box-shadow: inset 0 0 0 2px rgba(58,166,255,.80);
      background: rgba(58,166,255,.08);
    }
    .xw-cell.bad{
      background: rgba(229,72,93,.12);
      box-shadow: inset 0 0 0 2px rgba(229,72,93,.35);
    }
    .xw-cell.good{
      background: rgba(26,165,106,.10);
    }
    .xw-clues{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .xw-panel{
      border:1px solid var(--line);
      border-radius: 16px;
      background:#fff;
      box-shadow: var(--shadowSoft);
      padding:10px;
      overflow:hidden;
    }
    .xw-panel h3{
      margin:0 0 8px 0;
      font-size:12px;
      color:var(--muted);
      font-weight:950;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .xw-cluelist{
      display:grid;
      gap:8px;
      font-size:12px;
      color:var(--ink);
      line-height:1.3;
      max-height: 240px;
      overflow:auto;
      padding-right:4px;
    }
    .xw-clue{
      padding:8px;
      border:1px solid rgba(191,230,255,.75);
      border-radius:12px;
      background: rgba(58,166,255,.05);
    }
    .xw-clue .n{
      font-weight:950;
      color:var(--ink);
    }
    .xw-footnote{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hud">
      <div class="hud-center" id="hudTitle">JW Quiz</div>
      <div class="hud-right">
        <span class="hud-pill" title="Profil">üë§ <strong id="profileName">‚Äî</strong></span>
        <span class="hud-pill">ü™ô <strong id="coins">0</strong></span>
        <span class="hud-pill" id="heartsPill" style="display:none;">‚ù§Ô∏è <strong id="hearts">0</strong></span>
      </div>
    </div>

    <div class="track">
      <div class="track-line"></div>
      <div class="track-dot" id="trackDot" style="left:50%"></div>
      <div class="avatar left" title="Joueur">üôÇ</div>
      <div class="avatar right" title="Adversaire">üòÑ</div>
    </div>

    <div class="card">
      <div class="card-top">
        <div class="tag">
          <span id="qType">MENU</span>
          ‚Ä¢ Th√®me : <strong id="themeLabel">Mixte</strong>
          ‚Ä¢ Difficult√© : <strong id="diffStars">‚Äî</strong>
        </div>
        <div class="counter" id="counter">‚Äî</div>
      </div>

      <div class="qarea">
        <div class="qmedia" id="qmedia">üìò</div>
        <div class="qtext" id="qtext">Bienvenue</div>
      </div>

      <div class="ref" id="ref"></div>

      <div style="padding: 0 14px 14px;">
        <div id="gameArea"></div>
        <div class="result" id="resultBox" style="display:none;"></div>

        <div class="controls" id="controls" style="display:none;">
          <button class="ctrl gold" id="btnJoker">üÉè Joker (2 ü™ô)</button>
          <button class="ctrl" id="btnSkip">‚è≠Ô∏è Passer</button>
          <button class="ctrl danger" id="btnEnd">‚õî Finir</button>
        </div>

        <div class="footer" id="footer"></div>
      </div>
    </div>
  </div>

<script>
/* ========= Base (tes modes existants) ========= */
const THEMES = [
  { key:"Mixte", label:"Mixte", icon:"üîÄ", hint:"Toutes les questions (m√™me d√©j√† r√©ussies)" },
  { key:"Croyance", label:"Croyance", icon:"üìñ", hint:"Doctrine / foi / v√©rit√©s bibliques" },
  { key:"Qualit√©s chr√©tiennes", label:"Qualit√©s chr√©tiennes", icon:"üíõ", hint:"Amour, foi, patience..." },
  { key:"J√©hovah", label:"J√©hovah", icon:"‚ú®", hint:"Nom, qualit√©s, actions" },
  { key:"J√©sus", label:"J√©sus", icon:"üëë", hint:"Vie, enseignements" },
  { key:"Bible", label:"Bible", icon:"üìö", hint:"Livres, versets, structure" },
];

const QUESTIONS = [
  { id:"jw001", question:"Quelle est la qualit√© dominante de J√©hovah ?", answer:"Amour",
    options:["Amour","Joie","Patience","Bont√©"], reference:"1 Jean 4:8", difficulty:2, type:"TROU", theme:"J√©hovah" },
  { id:"jw002", question:"Car Dieu a tellement aim√© le monde qu‚Äôil a donn√© son Fils unique, afin que tous ceux qui exercent la ________ en lui ne soient pas d√©truits mais aient la vie √©ternelle.",
    answer:"Foi", options:["Foi","Patience","Mis√©ricorde","Bont√©"], reference:"Jean 3:16", difficulty:1, type:"QCM", theme:"Croyance" },
  { id:"jw003", question:"Marc a coup√© l‚Äôoreille d‚Äôun serviteur du grand pr√™tre ?",
    answer:"Faux", options:["Vrai","Faux"], reference:"C‚Äôest Pierre qui coupa l‚Äôoreille du serviteur. ‚Äì Jean 18:10",
    difficulty:1, type:"VF", theme:"Croyance" },
  { id:"jw004", question:"Mets les livres de la Bible dans l‚Äôordre.",
    answer:"Juges | 1 Rois | 1 Chroniques | N√©h√©mie | Lamentations | Daniel | Os√©e | Jo√´l | Nahum | Sophonie",
    options:null, reference:"", difficulty:3, type:"ORDRE", theme:"Bible" },
  { id:"jw005", question:"Quel est le nom de Dieu ?",
    answer:"J√©hovah", options:["J√©hovah","Jean-Pierre","Allah","J√©sus"], reference:"Psaume 83:18", difficulty:1, type:"QCM", theme:"Croyance" },
  { id:"jw006", question:"Qui est le fils unique de Dieu ?",
    answer:"J√©sus", options:["J√©sus","Adam","Gabriel","Marc"], reference:"Luc 22:29 ; Jean 3:16", difficulty:1, type:"QCM", theme:"Croyance" },
  { id:"jw007", question:"Quel est le premier livre de la Bible ?",
    answer:"Gen√®se", options:["Gen√®se","R√©v√©lation","Psaumes","Blanche neige"], reference:"", difficulty:1, type:"QCM", theme:"Bible" },
  { id:"jw008", question:"Combien de noms avait l'ap√¥tre Pierre ?",
    answer:"5", options:["5","2","1","7"],
    reference:"Ses noms √©taient Sym√©√¥n (h√©breu), Simon (grec), Pierre, C√©phas, Simon Pierre - Actes 15:14 ; Matthieu 10:2; 16:16 ; Jean 1:42",
    difficulty:2, type:"QCM", theme:"Bible" },
  { id:"jw009", question:"Combien y a-t-il d‚ÄôOints ?",
    answer:"144000", options:["144000","144001","144400","1"], reference:"R√©v√©lation 7:4 ; 14:1", difficulty:1, type:"QCM", theme:"Bible" },
  { id:"jw010", question:"Quel livre se trouve entre Mich√©e et Habacuc ?",
    answer:"Nahum", options:["Nahum","Matthieu","Jonas","Zacharie"], reference:"", difficulty:3, type:"QCM", theme:"Bible" },
  { id:"jw011", question:"Dans quel domaine devons-nous √™tre parfaits ?",
    answer:"En amour", options:["En amour","En toute chose","En richesse","Possible uniquement dans le paradis"],
    reference:"Matthieu 5:43-48", difficulty:4, type:"QCM", theme:"Croyance" },
  { id:"jw012", question:"Peux-tu mettre le fruit de l‚Äôesprit dans l‚Äôordre ?",
    answer:"Amour | joie | paix | patience | bienveillance | bont√© | foi | douceur | ma√Ætrise de soi",
    options:null, reference:"Galates 5:22,23", difficulty:4, type:"ORDRE", theme:"Bible" },
  { id:"jw013", question:"Comment s‚Äôappelle le 8e roi de Juda ?",
    answer:"Joas", options:["Joas","Joram","Amazia","David"], reference:"2 Rois 12:1", difficulty:5, type:"QCM", theme:"Bible" },
  { id:"jw014", question:"L‚Äôomer est une unit√© de mesure. √Ä combien √©quivaut un omer ?",
    answer:"2,2 litres", options:["2,2 litres","2 litres","1 litres","37 saisons et 797 √©pisodes"],
    reference:"Exode 16:16, note", difficulty:5, type:"QCM", theme:"Bible" },
  { id:"jw015", question:"Pourquoi J√©sus est-il venu sur terre ?",
    answer:"Pour sanctifier son P√®re et nous sauver",
    options:[
      "Pour sanctifier son P√®re et nous sauver",
      "Parce qu'il s'ennuyait au ciel",
      "Pour nous sauver",
      "Parce qu'il voulait go√ªter la carbonnade flamande"
    ],
    reference:"Jean 3:16 ; Jean 17:16",
    difficulty:1,
    type:"QCM",
    theme:"J√©sus"
  },
  { id:"jw016", question:"Quelle qualit√© est manifest√©e en Actes 20:35 ?",
    answer:"La g√©n√©rosit√©",
    options:["La g√©n√©rosit√©","La joie","La patience","La bont√©"],
    reference:"Actes 20:35",
    difficulty:3,
    type:"QCM",
    theme:"Qualit√©s chr√©tiennes"
  },
];

/* ======== NOUVEAU : banques "Mots crois√©s" (2 grilles) ======== */
const CROSSWORD_BANKS = [
  {
    key: "grille1",
    title: "Grille 1",
    subtitle: "Liste 1 (mixte)",
    items: [
      { id:"cw01", clue:"Si nous profitons de la d√©livrance qui nous est offerte par J√©sus, nous ne le serons plus [en trois mots] (Romains 6:6).", answer:"ESCLAVES DU P√âCH√â" },
      { id:"cw02", clue:"Personne qui a fait des √©tudes et qui exer√ßait bien souvent la fonction de notaire public (Juges 5:14).", answer:"SCRIBE" },
      { id:"cw03", clue:"Petit-fils d‚ÄôAaron (Exode 6:25).", answer:"PHIN√âHAS" },
      { id:"cw04", clue:"A exprim√© sa gaiet√© (Gen√®se 18:15).", answer:"RI" },
      { id:"cw05", clue:"Dans une expression signifiant: sans en avoir conscience (H√©breux 13:2).", answer:"INSU" },
      { id:"cw06", clue:"Color√©es (Exode 25:5).", answer:"TEINTES" },
      { id:"cw07", clue:"Femme de haute naissance (1 Rois 15:13).", answer:"DAME" },
      { id:"cw08", clue:"Cinqui√®me fils de Gad (Gen√®se 46:16).", answer:"√âRI" },
      { id:"cw09", clue:"Cuir (L√©vitique 4:11).", answer:"PEAU" },
      { id:"cw10", clue:"Sec (J√©r√©mie 50:12).", answer:"ARIDE" },
      { id:"cw11", clue:"Comble (Proverbes 29:21).", answer:"G√ÇTE" },
      { id:"cw12", clue:"J√©sus l‚Äô√©tait souvent [en trois mots] (Marc 1:41).", answer:"√âMU DE PITI√â" },
      { id:"cw13", clue:"R√©volte (Actes 19:40).", answer:"S√âDITION" },
      { id:"cw14", clue:"Premier-n√© de Juda (Gen√®se 38:2, 3).", answer:"ER" },
      { id:"cw15", clue:"Groupes d‚Äôinsectes (Exode 8:24).", answer:"ESSAIMS" },
    ],
  },
  {
    key: "grille2",
    title: "Grille 2",
    subtitle: "Liste 2 (verticalement)",
    items: [
      { id:"cw2_01", clue:"Paul priait pour que ses fr√®res le re√ßoivent [en trois mots] (√âph√©siens 1:17).", answer:"ESPRIT DE SAGESSE" },
      { id:"cw2_02", clue:"Ancien nom de la Babylonie (Gen√®se 10:10).", answer:"SCHIN√âAR" },
      { id:"cw2_03", clue:"Il peut √™tre joyeux (Psaume 105:43).", answer:"CRI" },
      { id:"cw2_04", clue:"Symbolise parfois la justice (R√©v√©lation 19:8).", answer:"LIN" },
      { id:"cw2_05", clue:"Premier sur la liste des t√©moins (H√©breux 11:4).", answer:"ABEL" },
      { id:"cw2_06", clue:"Ardeur (Actes 23:9).", answer:"V√âH√âMENCE" },
      { id:"cw2_07", clue:"Distrait (Juges 16:25).", answer:"AMUSE" },
      { id:"cw2_08", clue:"Qui ne saurait d√©cevoir (N√©h√©mie 7:2).", answer:"S√õR" },
      { id:"cw2_09", clue:"Dette (1 Corinthiens 7:3).", answer:"D√õ" },
      { id:"cw2_10", clue:"Se servant (Exode 38:8).", answer:"UTILISANT" },
      { id:"cw2_11", clue:"Mesure de poids (1 Samuel 13:21).", answer:"PIM" },
      { id:"cw2_12", clue:"Un homme vaillant de David (2 Samuel 23:24, 25).", answer:"√âLICA" },
      { id:"cw2_13", clue:"D√©monstratif (Actes 1:18).", answer:"CET" },
      { id:"cw2_14", clue:"Elle fut b√¢tie par Nimrod (Gen√®se 10:10, Darby).", answer:"√âREC" },
      { id:"cw2_15", clue:"Accablerez (Job 19:2).", answer:"√âCRASEREZ" },
    ],
  },
];

/* R√®gles */
const COINS_START = 0;
const COINS_PER_GOOD = 2;
const JOKER_COST = 2;
const ADVENTURE_HEARTS_START = 3;

/* Aventure */
const ADVENTURE_LEVELS = [
  { n:1,  name:"Tutoriel",   qCount:5,  minD:1, maxD:1,  minTypes:["QCM"],                  boss:false, bonusStars:[3,6,10] },
  { n:2,  name:"D√©part",     qCount:7,  minD:1, maxD:2,  minTypes:["QCM","VF"],            boss:false, bonusStars:[3,6,10] },
  { n:3,  name:"Chemin",     qCount:8,  minD:2, maxD:3,  minTypes:["QCM","VF","TROU"],     boss:false, bonusStars:[4,7,12] },
  { n:4,  name:"For√™t",      qCount:9,  minD:2, maxD:3,  minTypes:["QCM","TROU"],          boss:false, bonusStars:[4,7,12] },
  { n:5,  name:"Mini Boss",  qCount:10, minD:3, maxD:4,  minTypes:["QCM","ORDRE"],         boss:true,  bonusStars:[6,10,16] },
  { n:6,  name:"Mont√©e",     qCount:10, minD:3, maxD:4,  minTypes:["QCM","VF","TROU"],     boss:false, bonusStars:[5,9,14] },
  { n:7,  name:"Plateau",    qCount:10, minD:3, maxD:4,  minTypes:["QCM","ORDRE"],         boss:false, bonusStars:[5,9,14] },
  { n:8,  name:"√âpreuve",    qCount:10, minD:4, maxD:4,  minTypes:["QCM","TROU"],          boss:false, bonusStars:[6,10,16] },
  { n:9,  name:"Avant-boss", qCount:10, minD:4, maxD:5,  minTypes:["QCM","VF","ORDRE"],    boss:false, bonusStars:[7,12,18] },
  { n:10, name:"Boss",       qCount:10, minD:4, maxD:5,  minTypes:["QCM","VF","TROU","ORDRE"], boss:true, bonusStars:[10,16,24] },
];

/* Stockage */
const STORAGE_KEY = "jwquiz_full_v2025_12_19_crossword_banks";

/* Helpers */
const $ = (s)=>document.querySelector(s);
function normalize(s){
  return String(s ?? "").trim().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g," ");
}
function normalizeLettersOnly(s){
  const t = String(s ?? "")
    .toUpperCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^A-Z]/g,"");
  return t;
}
function esc(s){
  return String(s ?? "").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function stars(n){
  n=Math.max(1,Math.min(5,Number(n)||1));
  return "‚≠ê".repeat(n);
}
function pickMedia(q){
  const t=(q.type||"QCM").toUpperCase();
  if(t==="ORDRE") return "üß©";
  if(t==="TROU") return "üï≥Ô∏è";
  if(t==="VF") return "‚úÖ";
  const d=Number(q.difficulty)||1;
  return d<=1?"üìò":d===2?"üìó":d===3?"üìô":d===4?"üìï":"üëë";
}
function splitOrderAnswer(ans){
  const raw=String(ans??"").trim();
  if(!raw) return [];
  if(raw.includes("|")) return raw.split("|").map(x=>x.trim()).filter(Boolean);
  if(raw.includes(",")) return raw.split(",").map(x=>x.trim()).filter(Boolean);
  return raw.split(/\s+/).map(x=>x.trim()).filter(Boolean);
}

/* UI */
const ui = {
  coins: $("#coins"),
  profileName: $("#profileName"),
  hudTitle: $("#hudTitle"),
  trackDot: $("#trackDot"),
  qType: $("#qType"),
  themeLabel: $("#themeLabel"),
  diffStars: $("#diffStars"),
  counter: $("#counter"),
  qmedia: $("#qmedia"),
  qtext: $("#qtext"),
  ref: $("#ref"),
  gameArea: $("#gameArea"),
  resultBox: $("#resultBox"),
  controls: $("#controls"),
  btnJoker: $("#btnJoker"),
  btnSkip: $("#btnSkip"),
  btnEnd: $("#btnEnd"),
  footer: $("#footer"),
  heartsPill: $("#heartsPill"),
  hearts: $("#hearts"),
};

/* State */
const defaultState = () => ({
  version: 1,
  profile: null,
  coins: COINS_START,
  selectedTheme: "Mixte",
  correctIds: {},
  session: null,
  adventure: {
    currentLevel: 1,
    levelStars: {},
    hearts: ADVENTURE_HEARTS_START,
  },
  crossword: {
    last: null,
    wins: 0,
    selectedBank: "grille1",
  }
});
let state = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const st = raw ? Object.assign(defaultState(), JSON.parse(raw)) : defaultState();

    if(typeof st.coins !== "number") st.coins = COINS_START;
    if(!st.selectedTheme) st.selectedTheme = "Mixte";
    if(!st.correctIds || typeof st.correctIds !== "object") st.correctIds = {};
    if(!st.adventure || typeof st.adventure !== "object") st.adventure = defaultState().adventure;
    if(!st.crossword || typeof st.crossword !== "object") st.crossword = defaultState().crossword;

    if(!st.adventure.currentLevel) st.adventure.currentLevel = 1;
    if(!st.adventure.levelStars || typeof st.adventure.levelStars !== "object") st.adventure.levelStars = {};
    if(typeof st.adventure.hearts !== "number") st.adventure.hearts = ADVENTURE_HEARTS_START;

    if(typeof st.crossword.wins !== "number") st.crossword.wins = 0;
    if(!st.crossword.selectedBank) st.crossword.selectedBank = "grille1";

    return st;
  }catch(e){
    return defaultState();
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

function setHeartsVisible(show){
  ui.heartsPill.style.display = show ? "inline-flex" : "none";
}
function updateTopBar(){
  ui.coins.textContent = String(state.coins);
  ui.profileName.textContent = state.profile?.name ? state.profile.name : "‚Äî";
  ui.themeLabel.textContent = state.selectedTheme || "Mixte";
  ui.hearts.textContent = String(state.adventure?.hearts ?? 0);

  const inAdventure = state.session?.mode === "adventure";
  setHeartsVisible(inAdventure);
}
ui.hudTitle.onclick = ()=> renderModeMenu();

/* Save/Import */
function exportSave(){
  const data = {
    version: state.version,
    profile: state.profile,
    coins: state.coins,
    selectedTheme: state.selectedTheme,
    correctIds: state.correctIds,
    adventure: state.adventure,
    crossword: state.crossword,
    exportedAt: new Date().toISOString(),
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `jwquiz_save_${(state.profile?.name||"player").replace(/\s+/g,"_")}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function importSaveFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const data = JSON.parse(reader.result);
      if(!data || typeof data !== "object") throw new Error("invalid");

      state.profile = data.profile || state.profile;
      state.coins = Number.isFinite(data.coins) ? data.coins : state.coins;
      state.selectedTheme = data.selectedTheme || state.selectedTheme;
      state.correctIds = (data.correctIds && typeof data.correctIds === "object") ? data.correctIds : state.correctIds;

      if(data.adventure && typeof data.adventure === "object"){
        state.adventure.currentLevel = Number(data.adventure.currentLevel) || state.adventure.currentLevel;
        state.adventure.levelStars = (data.adventure.levelStars && typeof data.adventure.levelStars==="object")
          ? data.adventure.levelStars : state.adventure.levelStars;

        const h = Number(data.adventure.hearts);
        state.adventure.hearts = Number.isFinite(h) ? h : state.adventure.hearts;
      }

      if(data.crossword && typeof data.crossword === "object"){
        state.crossword.wins = Number(data.crossword.wins) || 0;
        state.crossword.last = data.crossword.last || null;
        state.crossword.selectedBank = data.crossword.selectedBank || state.crossword.selectedBank || "grille1";
      }

      state.session = null;
      saveState();
      renderModeMenu();
    }catch(e){
      ui.footer.innerHTML = "‚ö†Ô∏è Fichier de sauvegarde invalide.";
    }
  };
  reader.readAsText(file);
}

/* Profile */
function renderProfileGate(){
  updateTopBar();
  ui.qType.textContent = "COMPTE";
  ui.diffStars.textContent = "‚Äî";
  ui.counter.textContent = "‚Äî";
  ui.trackDot.style.left = "50%";
  ui.qmedia.textContent = "üë§";
  ui.qtext.textContent = "Cr√©er ton compte";
  ui.ref.style.display="none";
  ui.resultBox.style.display="none";
  ui.controls.style.display="none";
  ui.footer.innerHTML = "";
  setHeartsVisible(false);

  ui.gameArea.innerHTML = `
    <div class="hint">Ton compte reste enregistr√© sur cet appareil.</div>
    <div class="form">
      <div class="field">
        <div class="label">Pseudo *</div>
        <input class="input" id="inpName" maxlength="18" placeholder="Ex: Vincenzo" />
      </div>
      <button class="btn" id="btnCreate">‚úÖ Cr√©er mon compte</button>
    </div>
  `;

  $("#btnCreate").onclick = ()=>{
    const name = ($("#inpName").value || "").trim();
    if(!name){ ui.footer.innerHTML = "‚ö†Ô∏è Mets un pseudo."; return; }
    state.profile = { id: "id_"+Date.now(), name };
    saveState();
    renderModeMenu();
  };
}

/* Counts */
function computeCounts(){
  const correct = state.correctIds || {};
  const totalAll = QUESTIONS.length;
  const doneAll = Object.keys(correct).filter(id => QUESTIONS.some(q=>q.id===id)).length;

  const byTheme = {};
  THEMES.forEach(t=>{
    if(t.key === "Mixte") return;
    const list = QUESTIONS.filter(q => (q.theme||"Bible") === t.key);
    const done = list.filter(q => !!correct[q.id]).length;
    byTheme[t.key] = { total: list.length, remaining: Math.max(0, list.length - done), done };
  });

  return { totalAll, doneAll, remainingAll: Math.max(0, totalAll - doneAll), byTheme };
}

/* ----- MENU MODES ----- */
function getAdventureInfo(){
  const currentLevel = Math.max(1, Math.min(ADVENTURE_LEVELS.length, Number(state.adventure.currentLevel)||1));
  const starsMap = state.adventure.levelStars || {};
  const totalStars = Object.values(starsMap).reduce((a,b)=>a+(Number(b)||0),0);
  const cfg = ADVENTURE_LEVELS[currentLevel-1];
  const nextGoal = cfg.boss ? `Vaincre le boss (niveau ${cfg.n})` : `Valider le niveau ${cfg.n}`;
  return { currentLevel, totalStars, nextGoal };
}

function renderModeMenu(){
  updateTopBar();
  if(!state.profile){ renderProfileGate(); return; }

  const counts = computeCounts();
  const adv = getAdventureInfo();

  ui.qType.textContent = "ACCUEIL";
  ui.diffStars.textContent = "‚Äî";
  ui.counter.textContent = "‚Äî";
  ui.trackDot.style.left = "50%";
  ui.qmedia.textContent = "üéÆ";
  ui.qtext.textContent = `Choisis ton mode`;
  ui.ref.style.display="none";
  ui.resultBox.style.display="none";
  ui.controls.style.display="none";
  ui.footer.innerHTML = "";
  setHeartsVisible(false);

  ui.gameArea.innerHTML = `
    <div class="hint">
      üëã ${esc(state.profile.name)}
      ‚Ä¢ Pi√®ces : <strong>${state.coins}</strong>
      ‚Ä¢ R√©ussies : <strong>${counts.doneAll}</strong>/${counts.totalAll}
      ‚Ä¢ C≈ìurs aventure : <strong>‚ù§Ô∏è ${state.adventure.hearts}</strong>
      ‚Ä¢ Mots crois√©s gagn√©s : <strong>${state.crossword.wins}</strong>
    </div>

    <div class="mode-grid">
      <div class="mode-card">
        <div class="mode-top">
          <div class="mode-title">üìò Mode Classique</div>
        </div>
        <div class="mode-desc">
          Choisis un th√®me et r√©ponds aux questions (les bonnes r√©ponses sont exclues des cat√©gories, sauf Mixte).
        </div>
        <button class="btn" id="goClassic">‚ñ∂Ô∏è CLASSIQUE</button>
      </div>

      <div class="mode-card">
        <div class="mode-top">
          <div class="mode-title">üó∫Ô∏è Mode Aventure</div>
        </div>
        <div class="mode-desc">
          Progresse niveau par niveau, gagne des √©toiles ‚≠ê et des c≈ìurs ‚ù§Ô∏è.
          Niveau actuel : <strong>${adv.currentLevel}</strong>.
        </div>
        <button class="btn gold" id="goAdventure">üó∫Ô∏è AVENTURE</button>
      </div>

      <div class="mode-card">
        <div class="mode-top">
          <div class="mode-title">üß© Mode Mots crois√©s</div>
        </div>
        <div class="mode-desc">
          Grilles g√©n√©r√©es automatiquement. Accents tol√©r√©s. Gagne <strong>+10 ü™ô</strong> si 100% correct.
        </div>
        <button class="btn" id="goCrossword">üß© MOTS CROIS√âS</button>
      </div>
    </div>

    <div class="row">
      <button class="btn secondary" id="btnWins">üìñ Mes r√©ussites</button>
      <button class="btn secondary" id="btnSave">üíæ Sauvegarder</button>
    </div>

    <div class="row">
      <button class="btn secondary" id="btnImport">üì• Importer</button>
      <input type="file" id="fileImport" accept="application/json" style="display:none;">
    </div>
  `;

  $("#goClassic").onclick = ()=> renderClassicHome();
  $("#goAdventure").onclick = ()=> renderAdventureMap();
  $("#goCrossword").onclick = ()=> renderCrosswordHome();

  $("#btnWins").onclick  = ()=> renderSuccesses();
  $("#btnSave").onclick  = ()=> exportSave();
  $("#btnImport").onclick = ()=> $("#fileImport").click();
  $("#fileImport").onchange = (e)=>{
    const f = e.target.files && e.target.files[0];
    e.target.value = "";
    if(f) importSaveFile(f);
  };
}

/* ====== CLASSIQUE (inchang√©) ====== */
function renderClassicHome(){
  updateTopBar();
  const counts = computeCounts();

  ui.qType.textContent = "CLASSIQUE";
  ui.diffStars.textContent = "‚Äî";
  ui.counter.textContent = "‚Äî";
  ui.trackDot.style.left = "50%";
  ui.qmedia.textContent = "üìò";
  ui.qtext.textContent = `Mode Classique`;
  ui.ref.style.display="none";
  ui.resultBox.style.display="none";
  ui.controls.style.display="none";
  ui.footer.innerHTML = "";
  setHeartsVisible(false);

  ui.gameArea.innerHTML = `
    <div class="hint">
      Total : <strong>${counts.totalAll}</strong>
      ‚Ä¢ R√©ussies : <strong>${counts.doneAll}</strong>
      ‚Ä¢ Restantes (global) : <strong>${counts.remainingAll}</strong>
      ‚Ä¢ Pi√®ces : <strong>${state.coins}</strong>
    </div>

    <div class="hint" style="margin-top:12px;">Choisis un th√®me :</div>
    <div class="themes" id="themesGrid"></div>

    <button class="btn" id="btnStart">‚ñ∂Ô∏è COMMENCER</button>
    <button class="btn secondary" id="backModes">‚¨ÖÔ∏è Retour modes</button>
  `;

  $("#backModes").onclick = ()=> renderModeMenu();

  const grid = $("#themesGrid");
  grid.innerHTML = "";

  THEMES.forEach(t=>{
    const isSel = (state.selectedTheme || "Mixte") === t.key;

    let info = "";
    if(t.key === "Mixte"){
      info = `${t.hint} ‚Ä¢ ${counts.totalAll} questions`;
    }else{
      const c = counts.byTheme[t.key] || {total:0, remaining:0};
      info = `${t.hint} ‚Ä¢ ${c.remaining}/${c.total} restantes`;
    }

    const card = document.createElement("div");
    card.className = "theme-card" + (isSel ? " selected" : "");
    card.innerHTML = `
      <div class="t-top">
        <div class="t-name"><span class="t-ico">${t.icon}</span> ${esc(t.label)}</div>
        <div>${isSel ? "‚úÖ" : ""}</div>
      </div>
      <div class="t-sub">${esc(info)}</div>
    `;
    card.onclick = ()=>{
      state.selectedTheme = t.key;
      saveState();
      renderClassicHome();
    };
    grid.appendChild(card);
  });

  $("#btnStart").onclick = ()=> startClassicSession();
}

function getClassicPool(){
  const key = state.selectedTheme || "Mixte";
  if(key === "Mixte") return QUESTIONS.slice();
  return QUESTIONS.filter(q => (q.theme||"Bible") === key && !state.correctIds[q.id]);
}
function startClassicSession(){
  const pool = getClassicPool();
  if(!pool.length){
    ui.footer.innerHTML = "‚úÖ Tu as d√©j√† tout r√©ussi dans cette cat√©gorie ! (Mixte reste toujours disponible)";
    return;
  }
  const ids = shuffle(pool.map(q=>q.id));
  state.session = { ids, i:0, good:0, bad:0, orderState:null, mode:"classic", jokerUsed:false, answered:false };
  saveState();
  renderQuestion();
}

/* ====== AVENTURE (inchang√©) ====== */
function levelIsUnlocked(n){
  const current = Number(state.adventure.currentLevel)||1;
  return n <= current;
}
function getLevelStars(n){
  return Number((state.adventure.levelStars||{})[n]) || 0;
}
function setLevelStars(n, s){
  state.adventure.levelStars = state.adventure.levelStars || {};
  state.adventure.levelStars[n] = s;
}
function advanceAdventureIfNeeded(completedLevel, earnedStars){
  if(earnedStars >= 1){
    const current = Number(state.adventure.currentLevel)||1;
    if(completedLevel >= current && completedLevel < ADVENTURE_LEVELS.length){
      state.adventure.currentLevel = completedLevel + 1;
    }
  }
}

function renderAdventureMap(){
  updateTopBar();
  ui.qType.textContent = "AVENTURE";
  ui.diffStars.textContent = "‚Äî";
  ui.counter.textContent = "‚Äî";
  ui.trackDot.style.left = "50%";
  ui.qmedia.textContent = "üó∫Ô∏è";
  ui.qtext.textContent = "Carte d‚Äôaventure";
  ui.ref.style.display="none";
  ui.resultBox.style.display="none";
  ui.controls.style.display="none";
  ui.footer.innerHTML="";
  setHeartsVisible(false);

  const adv = getAdventureInfo();

  const mapHtml = ADVENTURE_LEVELS.map(cfg=>{
    const unlocked = levelIsUnlocked(cfg.n);
    const st = getLevelStars(cfg.n);
    const stTxt = st ? "‚≠ê".repeat(st) : "‚Äî";
    const lockTxt = unlocked ? "" : "üîí";
    const badge = cfg.boss ? "üëë" : "üèÅ";

    return `
      <div class="lvl" data-lvl="${cfg.n}">
        <div class="lvl-head">
          <div class="lvl-left">
            <div class="badge">${badge}</div>
            <div class="lvl-title">Niveau ${cfg.n} ‚Äî ${esc(cfg.name)}</div>
          </div>
          <div class="lvl-right">
            <div class="stars">${stTxt}</div>
            <div class="lock">${lockTxt}</div>
          </div>
        </div>
        <div class="lvl-body" hidden>
          <div class="pill">Questions : <strong>${cfg.qCount}</strong></div>
          <div class="pill">Difficult√© : <strong>${cfg.minD} ‚Üí ${cfg.maxD}</strong></div>
          <div class="pill">Types min : <strong>${cfg.minTypes.join(", ")}</strong></div>
          <button class="btn gold" ${unlocked ? "" : "disabled"} data-start="${cfg.n}">
            ‚ñ∂Ô∏è Jouer ce niveau
          </button>
        </div>
      </div>
    `;
  }).join("");

  ui.gameArea.innerHTML = `
    <div class="adv-banner">
      <div class="big">Ton aventure (Mixte)</div>
      <div class="small">
        Niveau actuel : <strong>${adv.currentLevel}</strong>
        ‚Ä¢ Total √©toiles : <strong>${adv.totalStars}</strong> ‚≠ê
        ‚Ä¢ C≈ìurs : <strong>‚ù§Ô∏è ${state.adventure.hearts}</strong><br/>
        ${esc(adv.nextGoal)}
      </div>
    </div>

    <div class="map" id="map">${mapHtml}</div>
    <button class="btn secondary" id="backModes">‚¨ÖÔ∏è Retour modes</button>
  `;

  $("#backModes").onclick = ()=> renderModeMenu();

  [...document.querySelectorAll(".lvl")].forEach(box=>{
    const head = box.querySelector(".lvl-head");
    const body = box.querySelector(".lvl-body");
    head.onclick = ()=>{ body.hidden = !body.hidden; };
  });
  [...document.querySelectorAll("[data-start]")].forEach(btn=>{
    btn.onclick = ()=>{
      const n = Number(btn.getAttribute("data-start"));
      startAdventureLevel(n);
    };
  });
}

function buildAdventureSession(cfg){
  const poolAll = QUESTIONS.slice();
  let pool = poolAll.filter(q=>{
    const d = Number(q.difficulty)||1;
    return d >= cfg.minD && d <= cfg.maxD;
  });
  if(pool.length < cfg.qCount) pool = poolAll.slice();

  const byType = {};
  pool.forEach(q=>{
    const t=(q.type||"QCM").toUpperCase();
    (byType[t] ||= []).push(q);
  });
  Object.keys(byType).forEach(k=>shuffle(byType[k]));

  const picked = [];
  cfg.minTypes.forEach(t=>{
    const T = t.toUpperCase();
    if(byType[T] && byType[T].length){
      const q = byType[T].pop();
      if(q) picked.push(q);
    }
  });

  const remainingPool = pool.slice().filter(q=>!picked.some(p=>p.id===q.id));
  shuffle(remainingPool);
  for(const q of remainingPool){
    if(picked.length >= cfg.qCount) break;
    picked.push(q);
  }

  if(picked.length < cfg.qCount){
    const fallback = poolAll.slice().filter(q=>!picked.some(p=>p.id===q.id));
    shuffle(fallback);
    for(const q of fallback){
      if(picked.length >= cfg.qCount) break;
      picked.push(q);
    }
  }

  return shuffle(picked.slice(0, cfg.qCount)).map(q=>q.id);
}

function startAdventureLevel(levelNumber){
  const cfg = ADVENTURE_LEVELS.find(x=>x.n===levelNumber);
  if(!cfg) return;
  if(!levelIsUnlocked(cfg.n)) return;

  const ids = buildAdventureSession(cfg);
  if(!ids.length){
    ui.footer.innerHTML = "‚ö†Ô∏è Pas assez de questions pour ce niveau (ajoute quelques questions et √ßa ira).";
    return;
  }

  state.session = {
    ids,
    i:0,
    good:0,
    bad:0,
    orderState:null,
    mode:"adventure",
    adv:{ level: cfg.n, levelCfg: cfg },
    jokerUsed:false,
    answered:false,
  };
  saveState();
  renderQuestion();
}

/* ----- üÉè JOKER (classique uniquement) ----- */
function updateJokerButton(){
  const s = state.session;
  const inClassic = s && s.mode === "classic";
  ui.btnJoker.style.display = inClassic ? "inline-block" : "none";
  if(!inClassic) return;

  const disabled = (state.coins < JOKER_COST) || !!s.jokerUsed || !!s.answered;
  ui.btnJoker.disabled = disabled;
  ui.btnJoker.textContent = `üÉè Joker (${JOKER_COST} ü™ô)`;
}

function consumeJokerCoins(){
  state.coins = Number(state.coins)||0;
  state.coins = Math.max(0, state.coins - JOKER_COST);
  saveState();
  updateTopBar();
}

function applyJoker(){
  const s = state.session;
  if(!s || s.mode !== "classic") return;
  if(s.jokerUsed || s.answered) return;
  if(state.coins < JOKER_COST){
    ui.footer.innerHTML = "‚ö†Ô∏è Pas assez de pi√®ces pour le Joker.";
    return;
  }

  const q = QUESTIONS.find(x=>x.id===s.ids[s.i]);
  if(!q) return;

  consumeJokerCoins();
  s.jokerUsed = true;
  saveState();
  updateTopBar();
  ui.footer.innerHTML = `üÉè Joker utilis√© (-${JOKER_COST} ü™ô)`;

  const qt = (q.type||"QCM").toUpperCase();

  if(qt === "QCM" || qt === "VF" || qt === "TROU"){
    const btns = [...ui.gameArea.querySelectorAll(".ansbtn")];
    if(btns.length){
      const correctBtn = btns.find(b => normalize(b.textContent) === normalize(q.answer));
      const wrongBtns = btns.filter(b => normalize(b.textContent) !== normalize(q.answer));
      const keepWrong = wrongBtns.length ? wrongBtns[Math.floor(Math.random()*wrongBtns.length)] : null;

      btns.forEach(b=>{
        const isCorrect = correctBtn && b === correctBtn;
        const isKeepWrong = keepWrong && b === keepWrong;
        if(isCorrect || isKeepWrong){
          b.disabled = false;
          b.style.opacity = "1";
        }else{
          b.disabled = true;
          b.style.opacity = ".35";
        }
      });
    }

    if(qt === "TROU"){
      const inp = $("#fillInput");
      if(inp){
        const ans = String(q.answer || "");
        const first = ans ? ans.trim().charAt(0) : "";
        const len = ans.trim().length;
        inp.placeholder = `Indice : commence par "${first}" ‚Ä¢ ${len} caract√®res`;
      }
    }

    updateJokerButton();
    return;
  }

  if(qt === "ORDRE"){
    if(!s.orderState || !Array.isArray(s.orderState.correct) || !Array.isArray(s.orderState.pool) || !Array.isArray(s.orderState.built)){
      updateJokerButton();
      return;
    }
    const nextIndex = s.orderState.built.length;
    const next = s.orderState.correct[nextIndex];
    if(!next){
      ui.footer.innerHTML = "üÉè Joker : l‚Äôordre est d√©j√† complet.";
      updateJokerButton();
      return;
    }
    const i = s.orderState.pool.findIndex(x => normalize(x) === normalize(next));
    if(i >= 0){
      s.orderState.built.push(s.orderState.pool[i]);
      s.orderState.pool.splice(i,1);
      saveState();
      if(typeof s.orderState.render === "function") s.orderState.render();
      ui.footer.innerHTML = `üÉè Joker : "${esc(next)}" plac√© au bon endroit !`;
    }else{
      ui.footer.innerHTML = "üÉè Joker : impossible de trouver l‚Äô√©l√©ment suivant.";
    }
    updateJokerButton();
    return;
  }

  updateJokerButton();
}

/* ----- Rendu questions (commun) ----- */
function renderQuestion(){
  const s = state.session;
  if(!s){ renderModeMenu(); return; }

  updateTopBar();
  ui.controls.style.display="flex";
  ui.resultBox.style.display="none";
  ui.ref.style.display="none";
  ui.footer.innerHTML = "";

  s.jokerUsed = false;
  s.answered = false;

  const total = s.ids.length;
  const idx = s.i;
  const q = QUESTIONS.find(x=>x.id===s.ids[idx]);
  if(!q){ endSession(); return; }

  ui.trackDot.style.left = `${total<=1?50:Math.max(8,Math.min(92,(idx/(total-1))*100))}%`;
  ui.counter.textContent = `${idx+1}/${total}`;
  ui.qType.textContent = (s.mode==="adventure")
    ? `AVENTURE ‚Ä¢ Niv ${s.adv?.level || "?"}`
    : (q.type||"QCM").toUpperCase();
  ui.diffStars.textContent = stars(q.difficulty);
  ui.qmedia.textContent = (s.mode==="adventure") ? (s.adv?.levelCfg?.boss ? "üëë" : "üó∫Ô∏è") : pickMedia(q);
  ui.qtext.textContent = q.question;

  const qt = (q.type||"QCM").toUpperCase();
  if(qt==="ORDRE") renderOrder(q);
  else if(qt==="VF") renderVF(q);
  else if(qt==="TROU") renderTrou(q);
  else renderQcm(q);

  ui.btnJoker.onclick = ()=> applyJoker();
  ui.btnSkip.onclick = ()=> validateAnswer(null, true);
  ui.btnEnd.onclick  = ()=> endSession();

  updateJokerButton();
}

/* R√©ponses */
function buildChoices(q){
  let opts = Array.isArray(q.options) ? q.options.slice() : [];
  opts = opts.map(x=>String(x).trim()).filter(Boolean);
  if(!opts.some(x=>normalize(x)===normalize(q.answer))) opts.unshift(String(q.answer).trim());
  opts = shuffle([...new Set(opts)]);
  while(opts.length < 4) opts.push("Je ne sais pas");
  return opts.slice(0,4);
}
function renderQcm(q){
  const choices = buildChoices(q);
  ui.gameArea.innerHTML = `<div class="answers" id="answers"></div>`;
  const answersEl = $("#answers");
  answersEl.dataset.locked="0";
  choices.forEach(txt=>{
    const b=document.createElement("button");
    b.className="ansbtn";
    b.textContent=txt;
    b.onclick=()=>{
      if(answersEl.dataset.locked==="1") return;
      answersEl.dataset.locked="1";
      validateAnswer(txt,false);
    };
    answersEl.appendChild(b);
  });
}
function renderVF(q){
  ui.gameArea.innerHTML = `<div class="answers" id="answers"></div>`;
  const answersEl = $("#answers");
  answersEl.dataset.locked="0";
  ["Vrai","Faux"].forEach(txt=>{
    const b=document.createElement("button");
    b.className="ansbtn";
    b.textContent=txt;
    b.onclick=()=>{
      if(answersEl.dataset.locked==="1") return;
      answersEl.dataset.locked="1";
      validateAnswer(txt,false);
    };
    answersEl.appendChild(b);
  });
}
function renderTrou(q){
  const choices = buildChoices(q);
  ui.gameArea.innerHTML = `
    <div class="hint">√âcris la r√©ponse ou choisis une proposition :</div>
    <div class="form" style="margin-top:10px;">
      <div class="field">
        <div class="label">Ta r√©ponse</div>
        <input class="input" id="fillInput" placeholder="√âcris ici..." />
      </div>
      <button class="btn secondary" id="btnValidateFill">‚úÖ Valider ce que j‚Äôai √©crit</button>
    </div>
    <div class="answers" id="answers" style="margin-top:12px;"></div>
  `;
  $("#btnValidateFill").onclick = ()=>{
    const v = ($("#fillInput").value || "").trim();
    if(!v){ ui.footer.innerHTML = "‚ö†Ô∏è √âcris une r√©ponse (ou clique sur une proposition)."; return; }
    validateAnswer(v,false);
  };
  const answersEl = $("#answers");
  answersEl.dataset.locked="0";
  choices.forEach(txt=>{
    const b=document.createElement("button");
    b.className="ansbtn";
    b.textContent=txt;
    b.onclick=()=>{
      if(answersEl.dataset.locked==="1") return;
      answersEl.dataset.locked="1";
      validateAnswer(txt,false);
    };
    answersEl.appendChild(b);
  });
}
function renderOrder(q){
  const s = state.session;
  const correct = splitOrderAnswer(q.answer);
  s.orderState = { correct, pool: shuffle(correct.slice()), built: [], render:null };
  saveState();

  ui.gameArea.innerHTML = `
    <div class="order-wrap">
      <div class="order-zone">
        <div class="order-title">√âl√©ments disponibles (clique pour ajouter)</div>
        <div class="chips" id="poolChips"></div>
      </div>
      <div class="order-zone">
        <div class="order-title">Ton ordre (clique pour retirer)</div>
        <div class="chips" id="builtChips"></div>
      </div>
      <button class="btn" id="btnValidateOrder">‚úÖ Valider</button>
    </div>
  `;
  const poolEl=$("#poolChips"), builtEl=$("#builtChips");
  function renderChips(){
    poolEl.innerHTML=""; builtEl.innerHTML="";
    s.orderState.pool.forEach((w,i)=>{
      const b=document.createElement("button");
      b.className="chipbtn"; b.textContent=w;
      b.onclick=()=>{
        s.orderState.built.push(w);
        s.orderState.pool.splice(i,1);
        saveState(); renderChips();
      };
      poolEl.appendChild(b);
    });
    s.orderState.built.forEach((w,i)=>{
      const b=document.createElement("button");
      b.className="chipbtn"; b.textContent=w;
      b.onclick=()=>{
        s.orderState.pool.push(w);
        s.orderState.built.splice(i,1);
        saveState(); renderChips();
      };
      builtEl.appendChild(b);
    });
  }
  s.orderState.render = renderChips;
  renderChips();
  $("#btnValidateOrder").onclick=()=> validateAnswer(s.orderState.built.slice(), false);
}

/* Marquer r√©ussite (global) */
function markCorrect(q){
  if(!q || !q.id) return;
  state.correctIds[q.id] = true;
  saveState();
}

/* ‚ù§Ô∏è Appliquer gain/perte de c≈ìurs (aventure seulement) */
function applyAdventureHearts(delta){
  state.adventure.hearts = Number(state.adventure.hearts) || 0;
  state.adventure.hearts += delta;
  if(state.adventure.hearts < 0) state.adventure.hearts = 0;
  saveState();
  updateTopBar();
}

/* Validation */
function validateAnswer(userAnswer, isSkip=false){
  const s = state.session;
  if(!s) return;

  const q = QUESTIONS.find(x=>x.id===s.ids[s.i]);
  const qtype = (q.type||"QCM").toUpperCase();

  let ok=false;
  if(qtype==="ORDRE"){
    const correct = splitOrderAnswer(q.answer);
    const built = Array.isArray(userAnswer) ? userAnswer : [];
    ok = normalize(built.join(" | ")) === normalize(correct.join(" | "));
  }else{
    ok = (!isSkip && userAnswer && normalize(userAnswer)===normalize(q.answer));
  }

  if(ok){
    s.good++;
    state.coins += COINS_PER_GOOD;
    markCorrect(q);
  }else{
    s.bad++;
  }

  if(s.mode === "adventure"){
    if(ok) applyAdventureHearts(+1);
    else if(!isSkip) applyAdventureHearts(-1);
  }

  s.answered = true;
  saveState();
  updateTopBar();
  updateJokerButton();

  [...ui.gameArea.querySelectorAll(".ansbtn")].forEach(b=>b.disabled=true);
  [...ui.gameArea.querySelectorAll(".chipbtn")].forEach(b=>b.disabled=true);
  const fill = $("#fillInput");
  if(fill) fill.disabled = true;
  const fillBtn = $("#btnValidateFill");
  if(fillBtn) fillBtn.disabled = true;

  if(qtype!=="ORDRE"){
    const btns=[...ui.gameArea.querySelectorAll(".ansbtn")];
    btns.forEach(b=>{
      if(normalize(b.textContent)===normalize(q.answer)) b.classList.add("correct");
      else if(userAnswer && normalize(b.textContent)===normalize(userAnswer) && !ok) b.classList.add("wrong");
    });
  }

  ui.ref.style.display="block";
  ui.ref.innerHTML = `R√©f√©rence : <strong>${esc(q.reference || "‚Äî")}</strong>`;

  ui.resultBox.style.display="block";
  ui.resultBox.className = "result " + (ok ? "good" : "bad");

  const heartLine = (s.mode === "adventure" && !isSkip)
    ? `<div class="small">‚ù§Ô∏è C≈ìurs : <strong>${state.adventure.hearts}</strong></div>`
    : "";

  const goodTitle = `‚úÖ Bonne r√©ponse ! (+${COINS_PER_GOOD} ü™ô)`;
  const badTitle = isSkip ? "‚è≠Ô∏è Pass√©." : "‚ùå Incorrect.";

  ui.resultBox.innerHTML = `
    <div class="title">${ok ? goodTitle : badTitle}</div>
    <div style="margin-top:6px"><strong>Bonne r√©ponse :</strong> ${esc(q.answer)}</div>
    <div class="small">üìñ ${esc(q.reference || "‚Äî")}</div>
    ${heartLine}
    <button class="btn" id="nextBtn" style="margin-top:10px;">‚û°Ô∏è Question suivante</button>
  `;

  $("#nextBtn").onclick=()=>{
    s.i++;
    s.orderState=null;
    saveState();
    if(s.i >= s.ids.length) endSession();
    else renderQuestion();
  };
}

function computeStarsFromScore(percent){
  if(percent >= 90) return 3;
  if(percent >= 70) return 2;
  if(percent >= 50) return 1;
  return 0;
}

function endSession(){
  const s = state.session;
  if(!s){ renderModeMenu(); return; }

  const total = s.ids.length || 1;
  const good = s.good || 0;
  const percent = Math.round((good/total)*100);

  if(s.mode === "adventure"){
    const lvl = s.adv?.level || 1;
    const cfg = s.adv?.levelCfg || ADVENTURE_LEVELS[lvl-1];
    const earnedStars = computeStarsFromScore(percent);

    const bonus = earnedStars ? (cfg.bonusStars[earnedStars-1] || 0) : 0;
    state.coins += bonus;

    const prev = getLevelStars(lvl);
    if(earnedStars > prev) setLevelStars(lvl, earnedStars);

    advanceAdventureIfNeeded(lvl, earnedStars);

    state.session = null;
    saveState();
    renderAdventureEnd(lvl, percent, earnedStars, bonus, cfg);
    return;
  }

  state.session = null;
  saveState();
  renderClassicHome();
}

function renderAdventureEnd(level, percent, earnedStars, bonus, cfg){
  updateTopBar();
  ui.qType.textContent = `AVENTURE ‚Ä¢ FIN`;
  ui.diffStars.textContent = "‚Äî";
  ui.counter.textContent = "‚Äî";
  ui.trackDot.style.left = "50%";
  ui.qmedia.textContent = cfg.boss ? "üëë" : "üèÅ";
  ui.qtext.textContent = `Niveau ${level} termin√© !`;
  ui.ref.style.display="none";
  ui.resultBox.style.display="none";
  ui.controls.style.display="none";
  ui.footer.innerHTML = "";
  setHeartsVisible(false);

  const starTxt = earnedStars ? "‚≠ê".repeat(earnedStars) : "‚Äî";
  const unlockMsg = (earnedStars>=1)
    ? (level < ADVENTURE_LEVELS.length ? "‚úÖ Niveau suivant d√©bloqu√© !" : "üèÜ Aventure termin√©e !")
    : "‚ùó Niveau non valid√© (il faut au moins 50%).";

  ui.gameArea.innerHTML = `
    <div class="adv-banner">
      <div class="big">R√©sultat</div>
      <div class="small">
        Score : <strong>${percent}%</strong> ‚Ä¢ √âtoiles : <strong>${starTxt}</strong> ‚Ä¢ Bonus : <strong>+${bonus} ü™ô</strong><br/>
        C≈ìurs : <strong>‚ù§Ô∏è ${state.adventure.hearts}</strong><br/>
        ${esc(unlockMsg)}
      </div>
    </div>

    <div class="row">
      <button class="btn gold" id="btnReplayLevel">üîÅ Rejouer le niveau</button>
      <button class="btn secondary" id="btnMap">üó∫Ô∏è Carte</button>
    </div>

    <button class="btn secondary" id="btnModes">‚¨ÖÔ∏è Retour modes</button>
  `;

  $("#btnReplayLevel").onclick = ()=> startAdventureLevel(level);
  $("#btnMap").onclick = ()=> renderAdventureMap();
  $("#btnModes").onclick = ()=> renderModeMenu();
}

/* Mes r√©ussites (simple) */
function renderSuccesses(){
  updateTopBar();
  ui.qType.textContent = "R√âUSSITES";
  ui.diffStars.textContent = "‚Äî";
  ui.counter.textContent = "‚Äî";
  ui.trackDot.style.left = "50%";
  ui.qmedia.textContent = "üìñ";
  ui.qtext.textContent = "Mes questions r√©ussies";
  ui.ref.style.display="none";
  ui.resultBox.style.display="none";
  ui.controls.style.display="none";
  ui.footer.innerHTML="";
  setHeartsVisible(false);

  const correctIds = state.correctIds || {};
  const ids = Object.keys(correctIds).filter(id => QUESTIONS.some(q=>q.id===id));

  if(!ids.length){
    ui.gameArea.innerHTML = `
      <div class="hint">Aucune question r√©ussie pour le moment.</div>
      <button class="btn" id="backModes">‚¨ÖÔ∏è Retour modes</button>
    `;
    $("#backModes").onclick=()=>renderModeMenu();
    return;
  }

  const groups = {};
  ids.forEach(id=>{
    const q = QUESTIONS.find(x=>x.id===id);
    const th = q.theme || "Autre";
    (groups[th] ||= []).push(q);
  });

  ui.gameArea.innerHTML = `
    <div class="hint">Total r√©ussies : <strong>${ids.length}</strong></div>
    <div id="acc"></div>
    <button class="btn secondary" id="backModes">‚¨ÖÔ∏è Retour modes</button>
  `;
  $("#backModes").onclick=()=>renderModeMenu();

  const acc=$("#acc");
  Object.keys(groups).forEach(th=>{
    const list = groups[th].slice().sort((a,b)=>a.question.localeCompare(b.question));
    const box=document.createElement("div");
    box.style.marginTop="10px";
    box.innerHTML = `<div class="hint"><strong>${esc(th)}</strong> ‚Äî ${list.length}</div>`;
    list.forEach(q=>{
      const it=document.createElement("div");
      it.className="result good";
      it.style.marginTop="8px";
      it.innerHTML = `<div class="title">‚úÖ ${esc(q.question)}</div>
                      <div class="small"><b>R√©ponse :</b> ${esc(q.answer)} ‚Ä¢ <b>R√©f :</b> ${esc(q.reference||"‚Äî")}</div>`;
      box.appendChild(it);
    });
    acc.appendChild(box);
  });
}

/* =======================
   MODE MOTS CROIS√âS
   ======================= */

function renderCrosswordHome(){
  updateTopBar();
  ui.qType.textContent = "MOTS CROIS√âS";
  ui.diffStars.textContent = "‚Äî";
  ui.counter.textContent = "‚Äî";
  ui.trackDot.style.left = "50%";
  ui.qmedia.textContent = "üß©";
  ui.qtext.textContent = "Mode Mots crois√©s";
  ui.ref.style.display="none";
  ui.resultBox.style.display="none";
  ui.controls.style.display="none";
  ui.footer.innerHTML="";
  setHeartsVisible(false);

  const selectedKey = state.crossword.selectedBank || "grille1";
  const banksHtml = CROSSWORD_BANKS.map(b=>{
    const sel = b.key === selectedKey;
    return `
      <div class="theme-card ${sel ? "selected" : ""}" data-bank="${esc(b.key)}">
        <div class="t-top">
          <div class="t-name"><span class="t-ico">üß©</span> ${esc(b.title)}</div>
          <div>${sel ? "‚úÖ" : ""}</div>
        </div>
        <div class="t-sub">${esc(b.subtitle)} ‚Ä¢ ${b.items.length} mots</div>
      </div>
    `;
  }).join("");

  ui.gameArea.innerHTML = `
    <div class="hint">
      <strong>Les mots crois√©s vont vous donner le plaisir le lire la Bible diff√©remment car pour ce mode de jeu ci, votre Bible vous sera tr√®s utile. Bon amusement.</strong>
    </div>

    <div class="hint" style="margin-top:10px;">
      Grille g√©n√©r√©e automatiquement depuis ta liste. ‚Ä¢ Accents tol√©r√©s (√â = E) ‚Ä¢ Espaces ignor√©s (ex: ‚Äú√âMU DE PITI√â‚Äù = une seule entr√©e)
    </div>

    <div class="hint" style="margin-top:10px;">
      Choisis ta grille :
    </div>

    <div class="themes" id="xwBanks">
      ${banksHtml}
    </div>

    <div class="row">
      <button class="btn gold" id="btnNewXW">üß© G√©n√©rer une grille</button>
      <button class="btn secondary" id="btnBackModes">‚¨ÖÔ∏è Retour modes</button>
    </div>

    <div class="hint" style="margin-top:12px;">
      Mots crois√©s gagn√©s : <strong>${state.crossword.wins}</strong>
    </div>
  `;

  $("#btnBackModes").onclick = ()=> renderModeMenu();

  [...document.querySelectorAll("#xwBanks [data-bank]")].forEach(card=>{
    card.onclick = ()=>{
      const k = card.getAttribute("data-bank");
      state.crossword.selectedBank = k;
      saveState();
      renderCrosswordHome();
    };
  });

  $("#btnNewXW").onclick = ()=> startCrossword();
}

function startCrossword(){
  const selectedKey = state.crossword.selectedBank || "grille1";
  const bank = CROSSWORD_BANKS.find(b=>b.key===selectedKey) || CROSSWORD_BANKS[0];

  const items = bank.items.map(x=>({
    id:x.id,
    clue:x.clue,
    answerRaw:x.answer,
    answer: normalizeLettersOnly(x.answer)
  })).filter(x=>x.answer.length >= 2);

  const gridSize = 17;
  const gen = generateCrossword(items, gridSize, 120);

  state.crossword.last = {
    gridSize,
    placements: gen.placements,
    grid: gen.grid,
    blocks: gen.blocks,
    meta: {
      placed: gen.placements.length,
      total: items.length,
      at: Date.now(),
      bankKey: bank.key,
      bankTitle: bank.title,
      won: false,
    }
  };
  saveState();
  renderCrosswordGame();
}

function renderCrosswordGame(){
  const last = state.crossword.last;
  if(!last){ renderCrosswordHome(); return; }

  updateTopBar();
  ui.qType.textContent = "MOTS CROIS√âS";
  ui.diffStars.textContent = "‚Äî";
  ui.counter.textContent = "‚Äî";
  ui.trackDot.style.left = "50%";
  ui.qmedia.textContent = "üß©";
  ui.qtext.textContent = "Compl√®te la grille";
  ui.ref.style.display="none";
  ui.resultBox.style.display="none";
  ui.controls.style.display="none";
  ui.footer.innerHTML="";
  setHeartsVisible(false);

  const size = last.gridSize;
  const blocks = last.blocks;
  const solution = last.grid;
  const placements = last.placements;

  const bankTotal = (last.meta && typeof last.meta.total === "number") ? last.meta.total : placements.length;
  const bankTitle = last.meta?.bankTitle ? last.meta.bankTitle : "Grille";

  const numbering = buildCrosswordNumbering(solution, blocks);
  const { across, down } = numbering.clues;
  const numGrid = numbering.numGrid;

  const itemByKey = {};
  placements.forEach(p=>{
    itemByKey[`${p.x},${p.y},${p.dir}`] = p.clue;
  });

  const acrossHtml = across.map(c=>{
    const clue = itemByKey[`${c.x},${c.y},A`] || "(d√©finition)";
    return `<div class="xw-clue"><span class="n">${c.n}.</span> ${esc(clue)}</div>`;
  }).join("");
  const downHtml = down.map(c=>{
    const clue = itemByKey[`${c.x},${c.y},D`] || "(d√©finition)";
    return `<div class="xw-clue"><span class="n">${c.n}.</span> ${esc(clue)}</div>`;
  }).join("");

  ui.gameArea.innerHTML = `
    <div class="xw-wrap">
      <div class="xw-toprow">
        <div class="xw-stats">
          <span class="hud-pill" style="background:rgba(0,0,0,.06); border-color: rgba(191,230,255,.8); color: var(--ink);">
            üß© <strong>${placements.length}</strong> / ${bankTotal} mots plac√©s ‚Ä¢ <strong>${esc(bankTitle)}</strong>
          </span>
          <span class="hud-pill" style="background:rgba(0,0,0,.06); border-color: rgba(191,230,255,.8); color: var(--ink);">
            üéÅ Gain: <strong>+10 ü™ô</strong> si 100% correct
          </span>
        </div>
        <div class="row" style="margin-top:0;">
          <button class="btn secondary" id="xwNew" style="min-width:160px;">üîÅ Nouvelle grille</button>
          <button class="btn gold" id="xwCheck" style="min-width:160px;">‚úÖ V√©rifier</button>
        </div>
      </div>

      <div class="xw-grid" id="xwGrid" style="grid-template-columns: repeat(${size}, max-content);"></div>

      <div class="xw-clues">
        <div class="xw-panel">
          <h3>‚û°Ô∏è Horizontales</h3>
          <div class="xw-cluelist">${acrossHtml || `<div class="hint">Aucune d√©finition (grille vide)</div>`}</div>
        </div>
        <div class="xw-panel">
          <h3>‚¨áÔ∏è Verticales</h3>
          <div class="xw-cluelist">${downHtml || `<div class="hint">Aucune d√©finition (grille vide)</div>`}</div>
        </div>
      </div>

      <div class="xw-footnote">
        Astuce : clique une case puis tape. Les accents sont tol√©r√©s (√â = E). Les r√©ponses avec espaces sont encha√Æn√©es.
      </div>

      <button class="btn secondary" id="xwBack">‚¨ÖÔ∏è Retour modes</button>
    </div>
  `;

  $("#xwBack").onclick = ()=> renderModeMenu();
  $("#xwNew").onclick = ()=> startCrossword();

  const gridEl = $("#xwGrid");
  const inputs = [];
  let selected = { x: -1, y: -1, dir: "A" };

  function setSelected(x,y){
    selected.x = x; selected.y = y;
    refreshSelected();
  }
  function refreshSelected(){
    gridEl.querySelectorAll(".xw-cell").forEach(c=>c.classList.remove("selected"));
    const idx = selected.y*size + selected.x;
    const cell = gridEl.children[idx];
    if(cell && cell.classList.contains("xw-cell") && !cell.classList.contains("block")){
      cell.classList.add("selected");
    }
  }

  function nextCell(x,y,dir){ return dir==="A" ? {x:x+1, y} : {x, y:y+1}; }
  function prevCell(x,y,dir){ return dir==="A" ? {x:x-1, y} : {x, y:y-1}; }
  function isIn(x,y){ return x>=0 && y>=0 && x<size && y<size; }
  function isBlock(x,y){ return !isIn(x,y) || blocks[y][x]; }

  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      const isBlk = blocks[y][x];
      const cell = document.createElement("div");
      cell.className = "xw-cell" + (isBlk ? " block" : "");
      if(!isBlk){
        const n = numGrid[y][x];
        if(n){
          const num = document.createElement("div");
          num.className="num";
          num.textContent = String(n);
          cell.appendChild(num);
        }
        const inp = document.createElement("input");
        inp.setAttribute("inputmode","text");
        inp.setAttribute("autocomplete","off");
        inp.setAttribute("autocapitalize","characters");
        inp.maxLength = 1;
        inp.dataset.x = String(x);
        inp.dataset.y = String(y);
        inp.value = "";

        inp.addEventListener("focus", ()=> setSelected(x,y));

        inp.addEventListener("click", ()=>{
          if(selected.x===x && selected.y===y){
            selected.dir = (selected.dir==="A") ? "D" : "A";
          }else{
            selected.dir = "A";
          }
          setSelected(x,y);
        });

        inp.addEventListener("keydown", (e)=>{
          const key = e.key;
          if(key === "Backspace"){
            e.preventDefault();
            if(inp.value){
              inp.value = "";
            }else{
              const p = prevCell(x,y,selected.dir);
              if(!isBlock(p.x,p.y)){
                const prev = inputs.find(z=>z.x===p.x && z.y===p.y)?.inp;
                if(prev){ prev.focus(); prev.value=""; }
              }
            }
            return;
          }
          if(key === "ArrowRight"){ e.preventDefault(); selected.dir="A"; const p=nextCell(x,y,"A"); if(!isBlock(p.x,p.y)) inputs.find(z=>z.x===p.x&&z.y===p.y)?.inp?.focus(); return; }
          if(key === "ArrowLeft"){ e.preventDefault(); selected.dir="A"; const p=prevCell(x,y,"A"); if(!isBlock(p.x,p.y)) inputs.find(z=>z.x===p.x&&z.y===p.y)?.inp?.focus(); return; }
          if(key === "ArrowDown"){ e.preventDefault(); selected.dir="D"; const p=nextCell(x,y,"D"); if(!isBlock(p.x,p.y)) inputs.find(z=>z.x===p.x&&z.y===p.y)?.inp?.focus(); return; }
          if(key === "ArrowUp"){ e.preventDefault(); selected.dir="D"; const p=prevCell(x,y,"D"); if(!isBlock(p.x,p.y)) inputs.find(z=>z.x===p.x&&z.y===p.y)?.inp?.focus(); return; }
        });

        inp.addEventListener("input", ()=>{
          const v = normalizeLettersOnly(inp.value).slice(0,1);
          inp.value = v;
          const p = nextCell(x,y,selected.dir);
          if(!isBlock(p.x,p.y)){
            inputs.find(z=>z.x===p.x && z.y===p.y)?.inp?.focus();
          }
        });

        cell.appendChild(inp);
        inputs.push({x,y,inp});
      }
      gridEl.appendChild(cell);
    }
  }

  const first = inputs[0]?.inp;
  if(first){ first.focus(); setSelected(Number(first.dataset.x), Number(first.dataset.y)); }

  $("#xwCheck").onclick = ()=>{
    gridEl.querySelectorAll(".xw-cell").forEach(c=>{
      c.classList.remove("bad","good");
    });

    let totalLetters = 0;
    let goodLetters = 0;

    for(const it of inputs){
      const x = it.x, y = it.y;
      const sol = solution[y][x] || "";
      if(!sol) continue;
      totalLetters++;
      const typed = normalizeLettersOnly(it.inp.value || "");
      if(typed === sol){
        goodLetters++;
        const idx = y*size + x;
        gridEl.children[idx].classList.add("good");
      }else{
        const idx = y*size + x;
        gridEl.children[idx].classList.add("bad");
      }
    }

    const percent = totalLetters ? Math.round((goodLetters/totalLetters)*100) : 0;
    const complete = (totalLetters > 0 && goodLetters === totalLetters);

    ui.resultBox.style.display = "block";
    ui.resultBox.className = "result " + (complete ? "good" : "bad");
    ui.resultBox.innerHTML = `
      <div class="title">${complete ? "üéâ Grille correcte !" : "üß† Continue !"}</div>
      <div class="small">Lettres correctes : <strong>${goodLetters}</strong> / ${totalLetters} (${percent}%)</div>
      ${complete ? `<div class="small">R√©compense : <strong>+10 ü™ô</strong></div>` : `<div class="small">Astuce : les accents sont tol√©r√©s (√â = E).</div>`}
    `;

    if(complete){
      if(!last.meta || !last.meta.won){
        state.coins += 10;
        state.crossword.wins = (Number(state.crossword.wins)||0) + 1;
        last.meta = last.meta || {};
        last.meta.won = true;
        state.crossword.last = last;
        saveState();
        updateTopBar();
      }
    }
  };
}

/* G√©n√©ration mots crois√©s (placement automatique) */
function generateCrossword(items, size, maxTries=120){
  function makeGrid(){
    const g = Array.from({length:size}, ()=>Array.from({length:size}, ()=>""));
    const b = Array.from({length:size}, ()=>Array.from({length:size}, ()=>true));
    return {g,b};
  }
  function inb(x,y){ return x>=0 && y>=0 && x<size && y<size; }

  function canPlace(grid, blocks, word, x, y, dir){
    const dx = dir==="A" ? 1 : 0;
    const dy = dir==="D" ? 1 : 0;

    const bx = x - dx, by = y - dy;
    const ax = x + dx*word.length, ay = y + dy*word.length;
    if(inb(bx,by) && !blocks[by][bx]) return false;
    if(inb(ax,ay) && !blocks[ay][ax]) return false;

    for(let i=0;i<word.length;i++){
      const cx = x + dx*i;
      const cy = y + dy*i;
      if(!inb(cx,cy)) return false;

      const ch = word[i];
      const existing = grid[cy][cx];
      if(existing && existing !== ch) return false;

      const left  = dir==="A" ? null : {x:cx-1,y:cy};
      const right = dir==="A" ? null : {x:cx+1,y:cy};
      const up    = dir==="D" ? null : {x:cx,y:cy-1};
      const down  = dir==="D" ? null : {x:cx,y:cy+1};

      if(left && inb(left.x,left.y) && !blocks[left.y][left.x] && !grid[cy][cx]) return false;
      if(right && inb(right.x,right.y) && !blocks[right.y][right.x] && !grid[cy][cx]) return false;
      if(up && inb(up.x,up.y) && !blocks[up.y][up.x] && !grid[cy][cx]) return false;
      if(down && inb(down.x,down.y) && !blocks[down.y][down.x] && !grid[cy][cx]) return false;
    }
    return true;
  }

  function place(grid, blocks, word, x, y, dir){
    const dx = dir==="A" ? 1 : 0;
    const dy = dir==="D" ? 1 : 0;
    for(let i=0;i<word.length;i++){
      const cx = x + dx*i;
      const cy = y + dy*i;
      grid[cy][cx] = word[i];
      blocks[cy][cx] = false;
    }
  }

  function allLetterPositions(grid){
    const pos = [];
    for(let y=0;y<size;y++){
      for(let x=0;x<size;x++){
        if(grid[y][x]) pos.push({x,y,ch:grid[y][x]});
      }
    }
    return pos;
  }

  let best = null;

  for(let attempt=0; attempt<maxTries; attempt++){
    const {g:grid, b:blocks} = makeGrid();
    const bag = shuffle(items.slice()).sort((a,b)=>b.answer.length - a.answer.length);
    const placements = [];

    const first = bag.shift();
    if(!first) break;

    const startX = Math.floor((size - first.answer.length)/2);
    const startY = Math.floor(size/2);
    if(startX < 0) continue;

    place(grid, blocks, first.answer, startX, startY, "A");
    placements.push({x:startX,y:startY,dir:"A",answer:first.answer, clue:first.clue, id:first.id});

    for(const it of bag){
      const word = it.answer;
      const letters = allLetterPositions(grid);
      let placed = false;

      const candidates = [];
      for(let i=0;i<word.length;i++){
        const ch = word[i];
        for(const L of letters){
          if(L.ch !== ch) continue;
          candidates.push({x: L.x - i, y: L.y, dir:"A"});
          candidates.push({x: L.x, y: L.y - i, dir:"D"});
        }
      }
      shuffle(candidates);

      for(const c of candidates){
        if(canPlace(grid, blocks, word, c.x, c.y, c.dir)){
          place(grid, blocks, word, c.x, c.y, c.dir);
          placements.push({x:c.x,y:c.y,dir:c.dir,answer:word, clue:it.clue, id:it.id});
          placed = true;
          break;
        }
      }

      if(!placed){
        const tries = 80;
        for(let t=0;t<tries;t++){
          const dir = Math.random()<0.5 ? "A" : "D";
          const x = Math.floor(Math.random()*size);
          const y = Math.floor(Math.random()*size);
          if(canPlace(grid, blocks, word, x, y, dir)){
            place(grid, blocks, word, x, y, dir);
            placements.push({x,y,dir,answer:word, clue:it.clue, id:it.id});
            placed = true;
            break;
          }
        }
      }
    }

    if(!best || placements.length > best.placements.length){
      best = {grid, blocks, placements};
      if(best.placements.length === items.length) break;
    }
  }

  if(!best){
    const {g,b} = makeGrid();
    return {grid:g, blocks:b, placements:[]};
  }
  return best;
}

function buildCrosswordNumbering(solution, blocks){
  const size = solution.length;
  const numGrid = Array.from({length:size}, ()=>Array.from({length:size}, ()=>0));
  const across = [];
  const down = [];
  let n = 0;

  function isBlock(x,y){ return blocks[y][x]; }
  function inb(x,y){ return x>=0 && y>=0 && x<size && y<size; }

  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      if(isBlock(x,y)) continue;
      const startA = (!inb(x-1,y) || isBlock(x-1,y)) && inb(x+1,y) && !isBlock(x+1,y);
      const startD = (!inb(x,y-1) || isBlock(x,y-1)) && inb(x,y+1) && !isBlock(x,y+1);

      if(startA || startD){
        n++;
        numGrid[y][x]=n;
        if(startA) across.push({n, x, y});
        if(startD) down.push({n, x, y});
      }
    }
  }

  return { numGrid, clues: { across, down } };
}

/* Boot */
function boot(){
  updateTopBar();
  if(!state.profile) renderProfileGate();
  else if(state.session && state.session.ids && state.session.ids.length) renderQuestion();
  else renderModeMenu();
}
boot();
</script>
</body>
</html>
